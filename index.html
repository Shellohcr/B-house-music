<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>B House | Agenda de Video</title>
  <meta name="description" content="Agenda tus paquetes de video con B House. Calendario tipo hotel, paquetes y horario de fines de semana." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --brand:#0ea5e9; --ink:#0f172a; --soft:#f1f5f9; }
    html,body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#0b1220;color:#e5e7eb}
    .glass{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.08)}
    .kbd{border:1px solid #3b4252;background:#0f172a;border-radius:.5rem;padding:.15rem .4rem;font-size:.75rem}
    .cal-grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:.5rem}
    .day-cell{aspect-ratio:1/1;border-radius:.75rem;padding:.5rem;display:flex;flex-direction:column;justify-content:space-between;border:1px dashed rgba(255,255,255,.08);cursor:pointer}
    .day-disabled{opacity:.35;filter:grayscale(.3);cursor:not-allowed}
    .day-selected{outline:2px solid #38bdf8}
    .slot{border:1px solid rgba(255,255,255,.1);border-radius:.75rem;padding:.6rem .75rem;display:flex;justify-content:space-between;align-items:center}
    .slot[disabled]{opacity:.4;cursor:not-allowed}
    .tag{font-size:.7rem;border:1px solid rgba(255,255,255,.18);padding:.1rem .4rem;border-radius:.4rem}
  </style>
</head>
<body class="min-h-screen selection:bg-sky-500/30">
  <header class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-sky-500/20 border border-sky-500/30 flex items-center justify-center">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#38bdf8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
        </div>
        <div>
          <h1 class="text-xl sm:text-2xl font-bold tracking-tight">B House Music ¬∑ Agenda de Video</h1>
          <p class="text-slate-400 text-sm">Sistema de reservas tipo hotel ¬∑ sin necesidad de crear cuenta</p>
        </div>
      </div>
      <a id="whatsHeader" href="https://wa.me/50670166631" target="_blank" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-emerald-400/30 text-emerald-300 hover:bg-emerald-400/10 transition">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M20.52 3.48A11.86 11.86 0 0012 0C5.37 0 0 5.37 0 12a11.86 11.86 0 001.68 6.06L0 24l6.13-1.6A11.86 11.86 0 0012 24c6.63 0 12-5.37 12-12 0-3.2-1.24-6.21-3.48-8.52zM12 21.5c-1.82 0-3.54-.5-5.04-1.45l-.36-.23-3.64.95.97-3.55-.24-.37A9.5 9.5 0 1121.5 12 9.52 9.52 0 0112 21.5zm5.26-6.9c-.29-.15-1.72-.85-1.98-.95-.27-.1-.46-.15-.65.15-.19.29-.75.94-.92 1.13-.17.19-.34.21-.63.08-.29-.14-1.22-.45-2.32-1.43a8.7 8.7 0 01-1.62-2.02c-.17-.29 0-.45.13-.6.13-.15.29-.37.44-.56.15-.19.2-.32.29-.53.1-.21.05-.39-.03-.54-.08-.15-.65-1.56-.9-2.12-.24-.58-.48-.5-.65-.5-.17 0-.37-.02-.56-.02-.19 0-.52.07-.79.38-.27.29-1.04 1.02-1.04 2.48 0 1.46 1.07 2.87 1.22 3.06.15.19 2.1 3.21 5.08 4.5.71.31 1.26.5 1.69.64.71.22 1.36.19 1.87.11.57-.08 1.72-.7 1.96-1.37.24-.68.24-1.26.17-1.38-.07-.12-.26-.2-.55-.36z"/></svg>
        <span class="text-sm font-semibold">WhatsApp</span>
      </a>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-24">
    <!-- Config summary / anuncios -->
    <section class="glass rounded-2xl p-4 sm:p-6 mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="space-y-1">
          <p class="text-slate-200 text-sm">Disponibilidad: <span class="font-semibold">S√°bados y Domingos</span> ¬∑ <span class="font-semibold">10:00 a. m.</span> a <span class="font-semibold">6:00 p. m.</span></p>
          <p class="text-slate-400 text-xs">√öltima hora permitida = que la sesi√≥n termine a m√°s tardar 6:00 p. m. (seg√∫n el paquete). Extra: $200/h si se excede.
            C√°mara incluida (no aparece en accesorios). En Express m√°ximo 2 accesorios. <strong>Drone no disponible en Express ni en ARTISTA.</strong></p>
        </div>
        <div class="flex gap-2 text-xs text-slate-300">
          <span class="kbd">1) Paquete</span>
          <span class="kbd">2) Click d√≠a</span>
          <span class="kbd">3) Elige hora</span>
          <span class="kbd">4) Reserva</span>
        </div>
      </div>
    </section>

    <!-- Paquetes -->
    <section class="grid md:grid-cols-3 gap-4 mb-8">
      <div class="glass rounded-2xl p-5" id="pkg-Express">
        <div class="flex items-center justify-between mb-1">
          <h2 class="text-lg font-bold">Express</h2>
          <span class="tag">60 min</span>
        </div>
        <p class="text-2xl font-extrabold">$200</p>
        <p class="text-slate-400 text-sm mb-4">Buffer de 2 h despu√©s. Incluye c√°mara. M√°ximo 2 accesorios. <strong>Sin Drone.</strong><br><span class="text-emerald-300 text-xs">Bloquea 3 horas del d√≠a</span></p>
        <button data-pkg="Express" class="selectPkg w-full mt-2 px-4 py-2 rounded-xl bg-sky-500/20 hover:bg-sky-500/30 border border-sky-400/40" aria-pressed="false">Elegir Express</button>
      </div>
      <div class="glass rounded-2xl p-5" id="pkg-ARTISTA">
        <div class="flex items-center justify-between mb-1">
          <h2 class="text-lg font-bold">ARTISTA</h2>
          <span class="tag">180 min</span>
        </div>
        <p class="text-2xl font-extrabold">$450</p>
        <p class="text-slate-400 text-sm mb-4">Incluye c√°mara. Hasta 5 accesorios. <strong>Sin Drone.</strong><br><span class="text-emerald-300 text-xs">Bloquea 5 horas del d√≠a</span></p>
        <button data-pkg="ARTISTA" class="selectPkg w-full mt-2 px-4 py-2 rounded-xl bg-sky-500/20 hover:bg-sky-500/30 border border-sky-400/40" aria-pressed="false">Elegir ARTISTA</button>
      </div>
      <div class="glass rounded-2xl p-5" id="pkg-Premium">
        <div class="flex items-center justify-between mb-1">
          <h2 class="text-lg font-bold">Premium</h2>
          <span class="tag">240 min</span>
        </div>
        <p class="text-2xl font-extrabold">$900</p>
        <p class="text-slate-400 text-sm mb-4">Paquete completo. Accesorios a elecci√≥n.<br><span class="text-emerald-300 text-xs">Reserva todo el d√≠a</span></p>
        <button data-pkg="Premium" class="selectPkg w-full mt-2 px-4 py-2 rounded-xl bg-sky-500/20 hover:bg-sky-500/30 border border-sky-400/40" aria-pressed="false">Elegir Premium</button>
      </div>
    </section>

    <!-- Accesorios -->
    <section class="glass rounded-2xl p-5 mb-8">
      <h3 class="font-semibold mb-2">Accesorios (opcional)</h3>
      <p class="text-slate-400 text-sm mb-4">La c√°mara SIEMPRE va incluida. Marca solo lo que necesitas adicional. En Express se permite m√°ximo 2 accesorios. Drone no disponible en Express ni en ARTISTA.</p>
      <div id="acc-list" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-2"></div>
    </section>

    <!-- Calendario + Slots -->
    <section class="grid lg:grid-cols-5 gap-6">
      <div class="lg:col-span-3 glass rounded-2xl p-5">
        <div class="flex items-center justify-between mb-3">
          <div>
            <h3 class="text-lg font-semibold" id="calTitle">Calendario</h3>
            <p class="text-slate-400 text-sm">Tipo hotel: elige el d√≠a disponible</p>
          </div>
          <div class="flex items-center gap-2">
            <button id="prevMonth" class="px-3 py-2 rounded-xl border border-slate-600 hover:bg-white/5" aria-label="Mes anterior">‚óÄ</button>
            <button id="nextMonth" class="px-3 py-2 rounded-xl border border-slate-600 hover:bg-white/5" aria-label="Mes siguiente">‚ñ∂</button>
          </div>
        </div>
        <div class="cal-grid text-sm mb-2 text-slate-400">
          <div>Lu</div><div>Ma</div><div>Mi</div><div>Ju</div><div>Vi</div><div>S√°</div><div>Do</div>
        </div>
        <div id="calGrid" class="cal-grid"></div>
        <p class="text-xs text-slate-400 mt-3">Gris = no disponible. Solo fines de semana. La hora se elige a la derecha.</p>
      </div>

      <div class="lg:col-span-2 glass rounded-2xl p-5">
        <h3 class="font-semibold mb-2">Horas disponibles <span id="slotDateLabel" class="text-slate-400 font-normal"></span></h3>
        <div id="slots" class="space-y-2 min-h-[200px]"></div>
      </div>
    </section>

    <!-- Resumen/Reserva -->
    <section class="glass rounded-2xl p-5 mt-8">
      <h3 class="font-semibold mb-4">Tu reserva</h3>
      <div class="grid md:grid-cols-2 gap-6">
        <div class="space-y-3" id="summary"></div>
        <form id="bookForm" class="space-y-3">
          <div class="grid sm:grid-cols-2 gap-3">
            <div>
              <label class="text-sm text-slate-300" for="name">Nombre y apellidos</label>
              <input required id="name" name="name" class="w-full mt-1 px-3 py-2 rounded-xl bg-white/5 border border-white/10" placeholder="Tu nombre" />
            </div>
            <div>
              <label class="text-sm text-slate-300" for="phone">Tel√©fono (WhatsApp)</label>
              <input required id="phone" name="phone" type="tel" class="w-full mt-1 px-3 py-2 rounded-xl bg-white/5 border border-white/10" placeholder="+506 ..." />
            </div>
          </div>
          <div class="grid sm:grid-cols-2 gap-3">
            <div>
              <label class="text-sm text-slate-300" for="email">Correo</label>
              <input type="email" required id="email" name="email" class="w-full mt-1 px-3 py-2 rounded-xl bg-white/5 border border-white/10" placeholder="tucorreo@..." />
            </div>
            <div>
              <label class="text-sm text-slate-300" for="location">Lugar / Direcci√≥n</label>
              <input id="location" name="location" class="w-full mt-1 px-3 py-2 rounded-xl bg-white/5 border border-white/10" placeholder="Ej. La Cali, San Jos√©" />
            </div>
          </div>
          <div>
            <label class="text-sm text-slate-300" for="notes">Notas</label>
            <textarea id="notes" name="notes" rows="3" class="w-full mt-1 px-3 py-2 rounded-xl bg-white/5 border border-white/10" placeholder="Detalles, referencias, etc."></textarea>
          </div>
          <div class="flex items-center gap-2">
            <input id="acceptTC" type="checkbox" class="h-4 w-4" required />
            <label for="acceptTC" class="text-sm">Acepto <button type="button" id="openTC" class="underline underline-offset-2">T√©rminos y Condiciones</button></label>
          </div>
          <div class="flex flex-wrap gap-2 pt-2">
            <button id="btnReserve" class="px-4 py-2 rounded-xl bg-sky-500 text-slate-900 font-bold" type="submit">Reservar</button>
            <button id="btnWhats" type="button" class="px-4 py-2 rounded-xl border border-emerald-400/40">Confirmar por WhatsApp</button>
            <button id="btnICS" type="button" class="px-4 py-2 rounded-xl border border-white/20">A√±adir a mi calendario (.ics)</button>
          </div>
          <p id="bookMsg" class="text-sm text-emerald-300 mt-2 hidden"></p>
        </form>
      </div>
    </section>

    <!-- Modal TyC -->
    <dialog id="tcModal" class="w-full max-w-3xl bg-slate-900/95 text-slate-100 rounded-2xl p-0 border border-white/10">
      <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
        <div class="flex items-center justify-between">
          <h4 class="text-lg font-bold">T√©rminos y Condiciones ‚Äî B House Music</h4>
          <button id="closeTC" class="px-3 py-2 rounded-xl border border-white/20">Cerrar</button>
        </div>
        <ol class="list-decimal list-inside text-sm text-slate-300 space-y-2">
          <li>Agenda disponible <strong>√∫nicamente</strong> s√°bados y domingos entre <strong>10:00 a. m.</strong> y <strong>6:00 p. m.</strong> La √∫ltima hora disponible depender√° del paquete elegido.</li>
          <li>Paquetes y precios (USD): Express $200 (60 min), ARTISTA $450 (180 min), Premium $900 (240 min). Hora adicional: $200.</li>
          <li>Paquete Express permite <strong>m√°ximo 2</strong> accesorios. <strong>Drone no disponible en Express ni en ARTISTA.</strong> La c√°mara est√° incluida en todos los paquetes.</li>
          <li>Si se excede el tiempo del paquete, se facturar√° la hora adicional indicada. La fracci√≥n superior a 15 minutos cuenta como hora completa.</li>
          <li>Reprogramaciones: con m√≠nimo 48 h de anticipaci√≥n. El mismo d√≠a no se reprograma salvo fuerza mayor.</li>
          <li>Al reservar se solicita confirmaci√≥n por WhatsApp. La fecha no se garantiza sin confirmaci√≥n.</li>
          <li>El desplazamiento fuera del GAM puede generar costos adicionales.</li>
          <li>Al enviar la reserva aceptas estas condiciones.</li>
        </ol>
      </div>
    </dialog>
  </main>

  <footer class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-10 pt-6 text-center text-xs text-slate-400">
    ¬© <span id="yyyy"></span> B House Music ¬∑ Hecho con ‚ô• ¬∑ <a class="underline" target="_blank" href="https://wa.me/50670166631">WhatsApp</a>
  </footer>

  <script>
    // ====== CONFIG EDITABLE ======
    const CONFIG = {
      TZ: 'America/Costa_Rica',
      // getDay(): 0=Dom,1=Lun,...,6=Sab
      workingDays: [0,6], // solo fines de semana
      startHour: 10,      // 10:00
      endHour: 18,        // 18:00 -> la sesi√≥n debe terminar a esta hora o antes
      stepMinutes: 30,    // intervalos para mostrar slots
      whatsappNumber: '50670166631',
      api: {
        // Opcional: si conectas Apps Script, descomenta y pon URLs:
        // availabilityGET: 'https://script.google.com/macros/s/XXXX/exec?action=availability',
        // bookingPOST: 'https://script.google.com/macros/s/XXXX/exec'
        availabilityGET: null,
        bookingPOST: null
      },
      packages: {
        Express:  { 
          price: 200, 
          duration: 60,  
          bufferAfter: 120, 
          maxAccessories: 2,   
          banned:['Drone'],
          blockMinutes: 180 // bloquea 3 horas
        },
        ARTISTA:  { 
          price: 450, 
          duration: 180, 
          bufferAfter: 0,   
          maxAccessories: 5,   
          banned:['Drone'],
          blockMinutes: 300 // bloquea 5 horas
        },
        Premium:  { 
          price: 900, 
          duration: 240, 
          bufferAfter: 0,   
          maxAccessories: 999, 
          banned:[],
          blockMinutes: 480 // bloquea todo el d√≠a (8 horas)
        }
      },
      extraHourUSD: 200,
      accessories: [
        'Estabilizador (gimbal)', 'Drone', 'Kit de luces', 'M√°quina de humo', 'Lente 85mm', 'Lente 28‚Äì70mm', 'Lente 11mm', 'Micr√≥fonos / audio', 'Tr√≠pode', 'Fondos / backdrops'
      ]
    };

    // ====== STATE ======
    const state = {
      pkgKey: null,
      acc: new Set(),
      dateISO: null,         // YYYY-MM-DD
      slotStart: null,       // 'HH:MM'
      dayBusy: [],           // [{start,end}] desde backend (opcional)
      currentMonth: new Date(new Date().getFullYear(), new Date().getMonth(), 1),
      selectedCell: null
    };

    // ====== UTILS ======
    const pad = n => String(n).padStart(2,'0');
    const fmtMoney = v => `$${v.toLocaleString('en-US', {minimumFractionDigits:0})}`;
    const toISODate = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const parseISODate = (iso) => { const [y,m,da]=iso.split('-').map(Number); return new Date(y, m-1, da); };
    const fmtHuman = (iso) => {
      const d = parseISODate(iso);
      return d.toLocaleDateString('es-CR', { weekday:'long', day:'2-digit', month:'long' });
    };
    const addMinutes = (timeStr, mins) => {
      const [H,M] = timeStr.split(':').map(Number);
      const d = new Date(); d.setHours(H, M, 0, 0); d.setMinutes(d.getMinutes()+mins);
      return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    };
    const toMinutes = (timeStr) => { const [H,M] = timeStr.split(':').map(Number); return H*60 + M; };
    const fromMinutes = (mins) => `${pad(Math.floor(mins/60))}:${pad(mins%60)}`;
    const overlaps = (aStart, aEnd, bStart, bEnd) => {
      const as = toMinutes(aStart), ae = toMinutes(aEnd);
      const bs = toMinutes(bStart), be = toMinutes(bEnd);
      return !(ae <= bs || as >= be);
    };
    const isPastDate = (d) => {
      const today = new Date(); today.setHours(0,0,0,0);
      const dd = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      return dd < today;
    };

    // ====== STORAGE (local) ======
    const LS_KEY = 'bhm_reservations';
    function loadReservations(){
      try { return JSON.parse(localStorage.getItem(LS_KEY) || '{}'); } catch(e){ return {}; }
    }
    function saveReservations(map){
      localStorage.setItem(LS_KEY, JSON.stringify(map));
    }
    function addReservation(dateISO, start, end, pkgKey, name, phone, email, location, notes){
      const map = loadReservations();
      if(!map[dateISO]) map[dateISO] = [];
      map[dateISO].push({ start, end, pkgKey, name, phone, email, location, notes, createdAt: new Date().toISOString() });
      saveReservations(map);
    }
    function getDayReservations(dateISO){
      const map = loadReservations();
      return map[dateISO] || [];
    }

    // ====== ACCESSORIOS RENDER ======
    const accWrap = document.getElementById('acc-list');
    CONFIG.accessories.forEach((label)=>{
      const el = document.createElement('label');
      el.className = 'flex items-center gap-2 p-2 rounded-xl border border-white/10 hover:bg-white/5';
      el.innerHTML = `<input type="checkbox" class="h-4 w-4" data-acc="${label}"> <span>${label}</span>`;
      accWrap.appendChild(el);
    });

    function refreshAccessoryStates(){
      const pkg = state.pkgKey ? CONFIG.packages[state.pkgKey] : null;
      document.querySelectorAll('#acc-list input[type="checkbox"]').forEach(chk=>{
        const label = chk.getAttribute('data-acc');
        const banned = pkg && pkg.banned.includes(label);
        // limpiar estados temporales
        chk.removeAttribute('data-temp-disabled');
        // aplicar reglas de banned
        chk.disabled = !!banned;
        chk.title = banned ? `No disponible en ${state.pkgKey}` : '';
        if(banned){ chk.checked = false; state.acc.delete(label); }
      });

      // Aplicar l√≠mite de accesorios
      if(pkg && state.acc.size >= pkg.maxAccessories){
        document.querySelectorAll('#acc-list input[type="checkbox"]:not(:checked)').forEach(uncheckedBox=>{
          if(!uncheckedBox.disabled){
            uncheckedBox.disabled = true;
            uncheckedBox.setAttribute('data-temp-disabled', 'true');
            uncheckedBox.title = `M√°ximo ${pkg.maxAccessories} accesorios`;
          }
        });
      } else {
        document.querySelectorAll('#acc-list input[data-temp-disabled]').forEach(tempBox=>{
          const tempLabel = tempBox.getAttribute('data-acc');
          const isBanned = pkg && pkg.banned.includes(tempLabel);
          if(!isBanned){
            tempBox.disabled = false;
            tempBox.removeAttribute('data-temp-disabled');
            tempBox.title = '';
          }
        });
      }
    }

    accWrap.addEventListener('change', (e)=>{
      if(!e.target.matches('input[type="checkbox"]')) return;
      const label = e.target.getAttribute('data-acc');
      const pkg = state.pkgKey ? CONFIG.packages[state.pkgKey] : null;
      if(e.target.checked){
        if(pkg && state.acc.size >= pkg.maxAccessories){
          e.target.checked = false;
          alert(`En el paquete ${state.pkgKey} solo se permiten ${pkg.maxAccessories} accesorios.`);
          return;
        }
        state.acc.add(label);
      } else {
        state.acc.delete(label);
      }
      refreshAccessoryStates();
      renderSummary();
    });

    // ====== PAQUETES ======
    document.querySelectorAll('.selectPkg').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        state.pkgKey = btn.dataset.pkg;
        document.querySelectorAll('[id^="pkg-"]').forEach(c=>{
          c.classList.remove('ring-2','ring-sky-400');
          const b = c.querySelector('.selectPkg');
          if(b) b.setAttribute('aria-pressed','false');
        });
        document.getElementById(`pkg-${state.pkgKey}`).classList.add('ring-2','ring-sky-400');
        btn.setAttribute('aria-pressed','true');

        // Limitar accesorios: recorta si excede
        const pkg = CONFIG.packages[state.pkgKey];
        if(state.acc.size > pkg.maxAccessories){
          state.acc = new Set([...state.acc].slice(0, pkg.maxAccessories));
        }
        // Sync checkboxes + ban Drone seg√∫n paquete
        document.querySelectorAll('#acc-list input[type="checkbox"]').forEach(chk=>{
          const label = chk.getAttribute('data-acc');
          chk.checked = state.acc.has(label);
        });
        refreshAccessoryStates();
        renderSummary();
        fetchAvailability();
        renderSlots();
        window.scrollTo({top: 0, behavior: 'smooth'});
      });
    });

    // ====== CALENDARIO ======
    const calTitle = document.getElementById('calTitle');
    const calGrid = document.getElementById('calGrid');
    const slotDateLabel = document.getElementById('slotDateLabel');

    function mondayIndex(jsDay){ return (jsDay + 6) % 7; } // 0=Lu ... 6=Do
    function renderCalendar(){
      const y = state.currentMonth.getFullYear();
      const m = state.currentMonth.getMonth();
      calTitle.textContent = state.currentMonth.toLocaleDateString('es-CR', { month:'long', year:'numeric' });

      calGrid.innerHTML = '';
      const first = new Date(y, m, 1);
      const daysInMonth = new Date(y, m+1, 0).getDate();
      const leadingBlanks = mondayIndex(first.getDay());

      // blanks
      for(let i=0;i<leadingBlanks;i++){
        const blank = document.createElement('div');
        calGrid.appendChild(blank);
      }

      for(let d=1; d<=daysInMonth; d++){
        const date = new Date(y, m, d);
        const cell = document.createElement('button');
        cell.type = 'button';
        cell.className = 'day-cell text-left';
        const isWeekend = CONFIG.workingDays.includes(date.getDay());
        const iso = toISODate(date);

        const labelTop = document.createElement('div');
        labelTop.className = 'text-xs text-slate-400';
        labelTop.textContent = d;

        const badge = document.createElement('div');
        badge.className = 'text-[10px] text-slate-300';
        badge.textContent = isWeekend ? 'Disponible' : '‚Äî';

        cell.appendChild(labelTop);
        cell.appendChild(badge);

        // disable rules
        if(!isWeekend || isPastDate(date)){
          cell.classList.add('day-disabled');
          cell.disabled = true;
        } else {
          cell.addEventListener('click', ()=>{
            state.dateISO = iso;
            state.slotStart = null;
            if(state.selectedCell) state.selectedCell.classList.remove('day-selected');
            cell.classList.add('day-selected');
            state.selectedCell = cell;
            slotDateLabel.textContent = `‚Äî ${fmtHuman(iso)}`;
            fetchAvailability();
            renderSlots();
            renderSummary();
          });
        }

        // If entire day already blocked (e.g., Premium previo), marca
        const res = getDayReservations(iso);
        const dayBlocked = res.some(r => r.start === '10:00' && r.end === '18:00');
        if(dayBlocked){
          badge.textContent = 'Ocupado';
          cell.classList.add('day-disabled');
          cell.disabled = true;
        }

        calGrid.appendChild(cell);
      }
    }

    document.getElementById('prevMonth').addEventListener('click', ()=>{
      state.currentMonth = new Date(state.currentMonth.getFullYear(), state.currentMonth.getMonth()-1, 1);
      renderCalendar();
    });
    document.getElementById('nextMonth').addEventListener('click', ()=>{
      state.currentMonth = new Date(state.currentMonth.getFullYear(), state.currentMonth.getMonth()+1, 1);
      renderCalendar();
    });

    // ====== AVAILABILITY (opcional backend) ======
    async function fetchAvailability(){
      state.dayBusy = [];
      if(!state.dateISO) return;
      if(CONFIG.api.availabilityGET){
        try{
          const url = new URL(CONFIG.api.availabilityGET);
          url.searchParams.set('date', state.dateISO);
          const r = await fetch(url, { cache:'no-store' });
          const j = await r.json();
          if(j && j.ok && Array.isArray(j.busy)) state.dayBusy = j.busy;
        }catch(e){ console.warn('availabilityGET error', e); }
      }
    }

    // ====== SLOTS ======
    const slotsWrap = document.getElementById('slots');
    function renderSlots(){
      slotsWrap.innerHTML = '';
      if(!state.pkgKey){
        slotsWrap.innerHTML = `<p class="text-slate-400 text-sm">Eleg√≠ primero un <strong>paquete</strong>.</p>`;
        return;
      }
      if(!state.dateISO){
        slotsWrap.innerHTML = `<p class="text-slate-400 text-sm">Ahora seleccion√° un <strong>d√≠a</strong> del calendario.</p>`;
        return;
      }

      const pkg = CONFIG.packages[state.pkgKey];
      const rangeStart = CONFIG.startHour * 60;
      const lastAllowedStart = (CONFIG.endHour * 60) - pkg.blockMinutes;

      // Premium: reservar todo el d√≠a (√∫nico slot 10:00)
      let candidateStarts = [];
      if(state.pkgKey === 'Premium'){
        if(isDayFreeForInterval(state.dateISO, '10:00', '18:00')){
          candidateStarts = ['10:00'];
        } else {
          slotsWrap.innerHTML = `<p class="text-slate-400 text-sm">Este d√≠a ya est√° reservado completo.</p>`;
          return;
        }
      } else {
        for(let t=rangeStart; t<=lastAllowedStart; t += CONFIG.stepMinutes){
          candidateStarts.push(fromMinutes(t));
        }
        // Filtra por choques
        candidateStarts = candidateStarts.filter(start=>{
          const end = addMinutes(start, pkg.blockMinutes);
          return isDayFreeForInterval(state.dateISO, start, end);
        });
      }

      if(candidateStarts.length === 0){
        slotsWrap.innerHTML = `<p class="text-slate-400 text-sm">No hay horas disponibles para este d√≠a con el paquete seleccionado.</p>`;
        return;
      }

      candidateStarts.forEach(start=>{
        const endBlock = addMinutes(start, pkg.blockMinutes);
        const endSession = addMinutes(start, pkg.duration);
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'slot w-full hover:bg-white/5';
        btn.innerHTML = `
          <div>
            <div class="font-semibold">${start} ‚Äî ${endSession}</div>
            <div class="text-xs text-slate-400">${state.pkgKey === 'Premium' ? 'Reserva todo el d√≠a (10:00‚Äì18:00)' : `Bloquea hasta ${endBlock}`}</div>
          </div>
          <div class="text-slate-300 text-sm">Elegir</div>
        `;
        btn.addEventListener('click', ()=>{
          state.slotStart = start;
          document.querySelectorAll('#slots .slot').forEach(b=>b.classList.remove('ring-2','ring-sky-400'));
          btn.classList.add('ring-2','ring-sky-400');
          renderSummary();
        });
        slotsWrap.appendChild(btn);
      });
    }

    function isDayFreeForInterval(dateISO, start, end){
      // 1) reservas locales
      const existing = getDayReservations(dateISO);
      for(const r of existing){
        if(overlaps(start, end, r.start, r.end)) return false;
      }
      // 2) busy del backend (opcional)
      for(const b of state.dayBusy){
        if(overlaps(start, end, b.start, b.end)) return false;
      }
      return true;
    }

    // ====== SUMMARY ======
    const summaryBox = document.getElementById('summary');
    function renderSummary(){
      const pkg = state.pkgKey ? CONFIG.packages[state.pkgKey] : null;
      const lines = [];
      lines.push(`<div><span class="text-slate-400 text-sm">Paquete:</span> <div class="text-lg font-bold">${state.pkgKey || '‚Äî'}</div></div>`);
      lines.push(`<div><span class="text-slate-400 text-sm">Fecha:</span> <div class="font-semibold">${state.dateISO ? fmtHuman(state.dateISO) : '‚Äî'}</div></div>`);
      if(state.slotStart){
        const endSession = pkg ? addMinutes(state.slotStart, pkg.duration) : '';
        const endBlock = pkg ? addMinutes(state.slotStart, pkg.blockMinutes) : '';
        lines.push(`<div><span class="text-slate-400 text-sm">Hora:</span> <div class="font-semibold">${state.slotStart} ‚Äî ${endSession}</div><div class="text-xs text-slate-400">${state.pkgKey==='Premium' ? 'Bloquea 10:00‚Äì18:00' : `Bloquea hasta ${endBlock}`}</div></div>`);
      } else {
        lines.push(`<div><span class="text-slate-400 text-sm">Hora:</span> <div class="font-semibold">‚Äî</div></div>`);
      }
      lines.push(`<div><span class="text-slate-400 text-sm">Accesorios:</span> <div>${[...state.acc].join(', ') || 'Ninguno'}</div></div>`);
      lines.push(`<div><span class="text-slate-400 text-sm">Precio:</span> <div class="text-xl font-extrabold">${pkg ? fmtMoney(pkg.price) : '‚Äî'}</div><div class="text-xs text-slate-400">Hora extra: ${fmtMoney(CONFIG.extraHourUSD)}</div></div>`);
      summaryBox.innerHTML = lines.map(l=>`<div class="p-3 rounded-xl border border-white/10">${l}</div>`).join('');
    }

    // ====== FORM / ACCIONES ======
    const form = document.getElementById('bookForm');
    const msg = document.getElementById('bookMsg');
    const btnICS = document.getElementById('btnICS');
    const btnWhats = document.getElementById('btnWhats');

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!state.pkgKey || !state.dateISO || !state.slotStart){
        alert('Seleccion√° paquete, fecha y hora antes de reservar.');
        return;
      }
      const pkg = CONFIG.packages[state.pkgKey];
      const start = state.pkgKey === 'Premium' ? '10:00' : state.slotStart;
      const end = state.pkgKey === 'Premium' ? '18:00' : addMinutes(state.slotStart, pkg.blockMinutes);

      // Verifica disponibilidad justo antes de grabar
      if(!isDayFreeForInterval(state.dateISO, start, end)){
        alert('Ese horario se ocup√≥ mientras seleccionabas. Eleg√≠ otra hora.');
        renderSlots();
        return;
      }

      const data = {
        date: state.dateISO, start, end,
        pkgKey: state.pkgKey, price: pkg.price,
        accessories: [...state.acc],
        name: form.name.value.trim(),
        phone: form.phone.value.trim(),
        email: form.email.value.trim(),
        location: form.location.value.trim(),
        notes: form.notes.value.trim(),
        tz: CONFIG.TZ
      };

      // 1) guarda local
      addReservation(data.date, data.start, data.end, data.pkgKey, data.name, data.phone, data.email, data.location, data.notes);

      // 2) opcional backend
      if(CONFIG.api.bookingPOST){
        try{
          const r = await fetch(CONFIG.api.bookingPOST, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ action:'book', payload:data }) });
          const j = await r.json();
          if(!j || !j.ok) console.warn('bookingPOST no-ok', j);
        }catch(err){ console.warn('bookingPOST error', err); }
      }

      msg.textContent = '¬°Listo! Tu horario se reserv√≥. Te escribimos por WhatsApp para confirmar detalles.';
      msg.classList.remove('hidden');

      // refresca UI
      renderCalendar();
      renderSlots();
    });

    btnICS.addEventListener('click', ()=>{
      if(!state.pkgKey || !state.dateISO || !state.slotStart){
        alert('Seleccion√° paquete, fecha y hora primero.');
        return;
      }
      const pkg = CONFIG.packages[state.pkgKey];
      const start = state.pkgKey === 'Premium' ? '10:00' : state.slotStart;
      const endSession = state.pkgKey === 'Premium' ? '14:00' : addMinutes(state.slotStart, pkg.duration); // sesi√≥n en s√≠ (no el bloqueo)
      const dtStart = toICSDateTime(state.dateISO, start);
      const dtEnd = toICSDateTime(state.dateISO, endSession);
      const ics = buildICS({
        summary: `B House ¬∑ ${state.pkgKey}`,
        description: `Paquete: ${state.pkgKey}\nAccesorios: ${[...state.acc].join(', ') || 'Ninguno'}\nPrecio: ${fmtMoney(pkg.price)}\nHora extra: ${fmtMoney(CONFIG.extraHourUSD)}\nContacto: +${CONFIG.whatsappNumber}`,
        location: document.getElementById('location').value || 'Por definir',
        dtStart, dtEnd
      });
      downloadText(`BHouse-${state.dateISO}-${start}.ics`, ics);
    });

    btnWhats.addEventListener('click', ()=>{
      if(!state.pkgKey || !state.dateISO || !state.slotStart){
        window.open(`https://wa.me/${CONFIG.whatsappNumber}`, '_blank');
        return;
      }
      const pkg = CONFIG.packages[state.pkgKey];
      const start = state.slotStart;
      const endSession = addMinutes(state.slotStart, pkg.duration);
      const txt = `Hola B House üëã\nQuiero confirmar mi reserva:\n‚Ä¢ Paquete: ${state.pkgKey}\n‚Ä¢ Fecha: ${fmtHuman(state.dateISO)}\n‚Ä¢ Hora: ${start} ‚Äî ${endSession}\n‚Ä¢ Accesorios: ${[...state.acc].join(', ') || 'Ninguno'}\n‚Ä¢ Precio: ${fmtMoney(pkg.price)}\n(Agenda fines de semana 10am‚Äì6pm)`;
      const url = `https://wa.me/${CONFIG.whatsappNumber}?text=${encodeURIComponent(txt)}`;
      window.open(url, '_blank');
    });

    // ====== ICS helpers ======
    function toICSDateTime(dateISO, timeHHMM){
      const [y,m,d] = dateISO.split('-').map(Number);
      const [H,Mi] = timeHHMM.split(':').map(Number);
      // Formato local (sin TZ) para que el calendario del usuario lo coloque seg√∫n su zona
      return `${y}${pad(m)}${pad(d)}T${pad(H)}${pad(Mi)}00`;
    }
    function buildICS({summary, description, location, dtStart, dtEnd}){
      return [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//B House Music//Agenda//ES',
        'BEGIN:VEVENT',
        `UID:${crypto.randomUUID()}`,
        `DTSTAMP:${toICSDateTime(toISODate(new Date()), `${pad(new Date().getHours())}:${pad(new Date().getMinutes())}`)}`,
        `DTSTART:${dtStart}`,
        `DTEND:${dtEnd}`,
        `SUMMARY:${summary}`,
        `DESCRIPTION:${description.replace(/\n/g, '\\n')}`,
        `LOCATION:${location}`,
        'END:VEVENT',
        'END:VCALENDAR'
      ].join('\r\n');
    }
    function downloadText(filename, content){
      const blob = new Blob([content], {type:'text/calendar;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }

    // ====== TyC modal ======
    const tcModal = document.getElementById('tcModal');
    document.getElementById('openTC').addEventListener('click', ()=> tcModal.showModal());
    document.getElementById('closeTC').addEventListener('click', ()=> tcModal.close());

    // ====== INIT ======
    document.getElementById('yyyy').textContent = new Date().getFullYear();
    renderCalendar();
    renderSummary();
  </script>
</body>
</html>
