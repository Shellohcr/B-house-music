<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>B House | Agenda de Video</title>
  <meta name="description" content="Agenda tus paquetes de video con B House.  Paquetes y horario de fines de semana." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --brand:#0ea5e9; --ink:#0f172a; --soft:#f1f5f9; }
    html,body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#0b1220;color:#e5e7eb}
    .glass{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.08)}
    .kbd{border:1px solid #3b4252;background:#0f172a;border-radius:.5rem;padding:.15rem .4rem;font-size:.75rem}
    .cal-grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:.5rem}
    .day-cell{aspect-ratio:1/1;border-radius:.75rem;padding:.5rem;display:flex;flex-direction:column;justify-content:space-between;border:1px dashed rgba(255,255,255,.08)}
    .day-disabled{opacity:.35;filter:grayscale(.3)}
    .slot{border:1px solid rgba(255,255,255,.1);border-radius:.75rem;padding:.6rem .75rem;display:flex;justify-content:space-between;align-items:center}
    .slot[disabled]{opacity:.4;cursor:not-allowed}
    .tag{font-size:.7rem;border:1px solid rgba(255,255,255,.18);padding:.1rem .4rem;border-radius:.4rem}
    code.badge{background:#ffffff1a;padding:.15rem .4rem;border-radius:.4rem}
  </style>
</head>
<body class="min-h-screen selection:bg-sky-500/30">
  <header class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-sky-500/20 border border-sky-500/30 flex items-center justify-center">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#38bdf8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
        </div>
        <div>
          <h1 class="text-xl sm:text-2xl font-bold tracking-tight">B House Music · Agenda de Video</h1>
          <p class="text-slate-400 text-sm"> Sin necesidad de crear cuenta</p>
        </div>
      </div>
      <a id="whatsHeader" target="_blank" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-emerald-400/30 text-emerald-300 hover:bg-emerald-400/10 transition">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M20.52 3.48A11.86 11.86 0 0012 0C5.37 0 0 5.37 0 12a11.86 11.86 0 001.68 6.06L0 24l6.13-1.6A11.86 11.86 0 0012 24c6.63 0 12-5.37 12-12 0-3.2-1.24-6.21-3.48-8.52zM12 21.5c-1.82 0-3.54-.5-5.04-1.45l-.36-.23-3.64.95.97-3.55-.24-.37A9.5 9.5 0 1121.5 12 9.52 9.52 0 0112 21.5zm5.26-6.9c-.29-.15-1.72-.85-1.98-.95-.27-.1-.46-.15-.65.15-.19.29-.75.94-.92 1.13-.17.19-.34.21-.63.08-.29-.14-1.22-.45-2.32-1.43a8.7 8.7 0 01-1.62-2.02c-.17-.29 0-.45.13-.6.13-.15.29-.37.44-.56.15-.19.2-.32.29-.53.1-.21.05-.39-.03-.54-.08-.15-.65-1.56-.9-2.12-.24-.58-.48-.5-.65-.5-.17 0-.37-.02-.56-.02-.19 0-.52.07-.79.38-.27.29-1.04 1.02-1.04 2.48 0 1.46 1.07 2.87 1.22 3.06.15.19 2.1 3.21 5.08 4.5.71.31 1.26.5 1.69.64.71.22 1.36.19 1.87.11.57-.08 1.72-.7 1.96-1.37.24-.68.24-1.26.17-1.38-.07-.12-.26-.2-.55-.36z"/></svg>
        <span class="text-sm font-semibold">WhatsApp</span>
      </a>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-24">
    <!-- Config summary / anuncios -->
    <section class="glass rounded-2xl p-4 sm:p-6 mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="space-y-1">
          <p class="text-slate-200 text-sm">Disponibilidad: <span class="font-semibold">Sábados y Domingos</span> · <span class="font-semibold">10:00 a. m.</span> a <span class="font-semibold">6:00 p. m.</span></p>
          <p class="text-slate-400 text-xs">Cámara incluida (no aparece en accesorios). En paquete Express máximo 2 accesorios. <strong>Drone no disponible en Express ni en ARTISTA.</strong></p>
        </div>
        <div class="flex gap-2 text-xs text-slate-300">
          <span class="kbd">? Paquete</span>
          <span class="kbd">Click día</span>
          <span class="kbd">Elige hora</span>
          <span class="kbd">Reserva</span>
        </div>
      </div>
    </section>

    <!-- Paquetes -->
    <section class="grid md:grid-cols-3 gap-4 mb-8">
      <div class="glass rounded-2xl p-5" id="pkg-Express">
        <div class="flex items-center justify_between mb-1">
          <h2 class="text-lg font-bold">Express</h2>
          <span class="tag">60 min</span>
        </div>
        <p class="text-2xl font-extrabold">$200</p>
        <p class="text-slate-400 text-sm mb-4">Buffer de 2 h después. Incluye cámara. Máximo 2 accesorios. <strong>Sin Drone.</strong></p>
        <button data-pkg="Express" class="selectPkg w-full mt-2 px-4 py-2 rounded-xl bg-sky-500/20 hover:bg-sky-500/30 border border-sky-400/40">Elegir Express</button>
      </div>
      <div class="glass rounded-2xl p-5" id="pkg-ARTISTA">
        <div class="flex items-center justify-between mb-1">
          <h2 class="text-lg font-bold">ARTISTA</h2>
          <span class="tag">180 min (3 h)</span>
        </div>
        <p class="text-2xl font-extrabold">$450</p>
        <p class="text-slate-400 text-sm mb-4">Incluye cámara. Hasta 5 accesorios. <strong>Sin Drone.</strong></p>
        <button data-pkg="ARTISTA" class="selectPkg w-full mt-2 px-4 py-2 rounded-xl bg-sky-500/20 hover:bg-sky-500/30 border border-sky-400/40">Elegir ARTISTA</button>
      </div>
      <div class="glass rounded-2xl p-5" id="pkg-Premium">
        <div class="flex items-center justify-between mb-1">
          <h2 class="text-lg font-bold">Premium</h2>
          <span class="tag">360 min (6 h)</span>
        </div>
        <p class="text-2xl font-extrabold">$900</p>
        <p class="text-slate-400 text-sm mb-4">Paquete completo. Accesorios a elección.</p>
        <button data-pkg="Premium" class="selectPkg w-full mt-2 px-4 py-2 rounded-xl bg-sky-500/20 hover:bg-sky-500/30 border border-sky-400/40">Elegir Premium</button>
      </div>
    </section>

    <!-- Accesorios -->
    <section class="glass rounded-2xl p-5 mb-8">
      <h3 class="font-semibold mb-2">Accesorios (opcional)</h3>
      <p class="text-slate-400 text-sm mb-4">La cámara SIEMPRE va incluida. Marca solo lo que necesitas adicional. En Express se permite máximo 2 accesorios. Drone no disponible en Express ni en ARTISTA.</p>
      <div id="acc-list" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-2"></div>
    </section>

    <!-- Calendario + Slots -->
    <section class="grid lg:grid-cols-5 gap-6">
      <div class="lg:col-span-3 glass rounded-2xl p-5">
        <div class="flex items-center justify-between mb-3">
          <div>
            <h3 class="font-semibold text-lg" id="calTitle">Calendario</h3>
            <p class="text-slate-400 text-sm">Tipo hotel: elige el día disponible</p>
          </div>
          <div class="flex items-center gap-2">
            <button id="prevMonth" class="px-3 py-2 rounded-xl border border-slate-600 hover:bg-white/5">◀</button>
            <button id="nextMonth" class="px-3 py-2 rounded-xl border border-slate-600 hover:bg-white/5">▶</button>
          </div>
        </div>
        <div class="cal-grid text-sm mb-2 text-slate-400">
          <div>Lu</div><div>Ma</div><div>Mi</div><div>Ju</div><div>Vi</div><div>Sá</div><div>Do</div>
        </div>
        <div id="calGrid" class="cal-grid"></div>
        <p class="text-xs text-slate-400 mt-3">Gris = no disponible. Solo fines de semana. La hora se elige a la derecha.</p>
      </div>

      <div class="lg:col-span-2 glass rounded-2xl p-5">
        <h3 class="font-semibold mb-2">Horas disponibles <span id="slotDateLabel" class="text-slate-400 font-normal"></span></h3>
        <div id="slots" class="space-y-2 min-h-[200px]"></div>
      </div>
    </section>

    <!-- Resumen/Reserva -->
    <section class="glass rounded-2xl p-5 mt-8">
      <h3 class="font-semibold mb-4">Tu reserva</h3>
      <div class="grid md:grid-cols-2 gap-6">
        <div class="space-y-3" id="summary"></div>
        <form id="bookForm" class="space-y-3">
          <div class="grid sm:grid-cols-2 gap-3">
            <div>
              <label class="text-sm text-slate-300">Nombre y apellidos</label>
              <input required name="name" class="w-full mt-1 px-3 py-2 rounded-xl bg-white/5 border border-white/10" placeholder="Tu nombre" />
            </div>
            <div>
              <label class="text-sm text-slate-300">Teléfono (WhatsApp)</label>
              <input required name="phone" class="w-full mt-1 px-3 py-2 rounded-xl bg-white/5 border border-white/10" placeholder="+506 ..." />
            </div>
          </div>
          <div class="grid sm:grid-cols-2 gap-3">
            <div>
              <label class="text-sm text-slate-300">Correo</label>
              <input type="email" required name="email" class="w-full mt-1 px-3 py-2 rounded-xl bg-white/5 border border-white/10" placeholder="tucorreo@..." />
            </div>
            <div>
              <label class="text-sm text-slate-300">Lugar / Dirección</label>
              <input name="location" class="w-full mt-1 px-3 py-2 rounded-xl bg-white/5 border border-white/10" placeholder="Ej. La Cali, San José" />
            </div>
          </div>
          <div>
            <label class="text-sm text-slate-300">Notas</label>
            <textarea name="notes" rows="3" class="w-full mt-1 px-3 py-2 rounded-xl bg-white/5 border border-white/10" placeholder="Detalles, referencias, etc."></textarea>
          </div>
          <div class="flex items-center gap-2">
            <input id="acceptTC" type="checkbox" class="h-4 w-4" required />
            <label for="acceptTC" class="text-sm">Acepto <button type="button" id="openTC" class="underline underline-offset-2">Términos y Condiciones</button></label>
          </div>
          <div class="flex flex-wrap gap-2 pt-2">
            <button id="btnReserve" class="px-4 py-2 rounded-xl bg-sky-500 text-slate-900 font-bold">Reservar</button>
            <button id="btnWhats" type="button" class="px-4 py-2 rounded-xl border border-emerald-400/40">Confirmar por WhatsApp</button>
            <button id="btnICS" type="button" class="px-4 py-2 rounded-xl border border-white/20">Añadir a mi calendario (.ics)</button>
          </div>
          <p id="bookMsg" class="text-sm text-emerald-300 mt-2 hidden"></p>
        </form>
      </div>
    </section>

    <!-- Cancelación por consecutivo -->
    <section class="glass rounded-2xl p-5 mt-6">
      <h3 class="font-semibold mb-3">Cancelar / Rehabilitar reserva (por consecutivo)</h3>
      <div class="flex flex-col sm:flex-row gap-2">
        <input id="cancelId" class="w-full px-3 py-2 rounded-xl bg-white/5 border border-white/10" placeholder="Ej. BHM-20250812-0003" />
        <button id="btnLocate" type="button" class="px-4 py-2 rounded-xl border border-white/20">Ver en calendario</button>
        <button id="btnCancel" type="button" class="px-4 py-2 rounded-xl bg-rose-500/90 text-slate-900 font-bold">Eliminar y liberar</button>
      </div>
      <p id="cancelMsg" class="text-sm mt-2 text-slate-300"></p>
    </section>

    <!-- Modal TyC -->
    <dialog id="tcModal" class="w-full max-w-3xl bg-slate-900/95 text-slate-100 rounded-2xl p-0 border border-white/10">
      <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
        <div class="flex items-center justify-between">
          <h4 class="text-lg font-bold">Términos y Condiciones — B House Music</h4>
          <button id="closeTC" class="px-3 py-2 rounded-xl border border-white/20">Cerrar</button>
        </div>
        <ol class="list-decimal list-inside text-sm text-slate-300 space-y-2">
          <li>Agenda disponible <strong>únicamente</strong> sábados y domingos entre <strong>10:00 a. m.</strong> y <strong>6:00 p. m.</strong> La última hora disponible dependerá del paquete elegido.</li>
          <li>Paquetes y precios (USD): Express $200 (60 min), ARTISTA $450 (180 min), Premium $900 (360 min). Hora adicional: $200.</li>
          <li>Paquete Express permite <strong>máximo 2</strong> accesorios. <strong>Drone no disponible en Express ni en ARTISTA.</strong> La cámara está incluida en todos los paquetes.</li>
          <li>Si se excede el tiempo del paquete, se facturará la hora adicional indicada. La fracción superior a 15 minutos cuenta como hora completa.</li>
          <li>Reprogramaciones: con mínimo 48 h de anticipación. El mismo día no se reprograma salvo fuerza mayor.</li>
          <li>Al reservar se solicita confirmación por WhatsApp. La fecha no se garantiza sin confirmación.</li>
          <li>El desplazamiento fuera del GAM puede generar costos adicionales.</li>
          <li>Al enviar la reserva aceptas estas condiciones.</li>
        </ol>
      </div>
    </dialog>
  </main>

  <footer class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-10 pt-6 text-center text-xs text-slate-400">
    © <span id="yyyy"></span> B House Music · Hecho con ♥ · <a class="underline" target="_blank" href="https://wa.me/50670166631">WhatsApp</a>
  </footer>

  <script>
    // ====== CONFIG EDITABLE ======
    const CONFIG = {
      TZ: 'America/Costa_Rica',
      workingDays: [0,6], // 0=Dom, 6=Sab (solo fines de semana)
      startHour: 10,      // 10:00
      endHour: 18,        // 18:00 -> la sesión debe terminar a esta hora o antes
      stepMinutes: 30,    // intervalos base (se ignora para ciertas reglas por paquete)
      whatsappNumber: '50670166631',
      api: {
        // availabilityGET debe responder: { ok:true, busy:[{start:'HH:MM', end:'HH:MM'}] }
        // bookingPOST debe aceptar el payload y devolver { ok:true, id:'<consecutivo>' }
        availabilityGET: null, // 'https://script.google.com/macros/s/XXXX/exec?action=availability&date=YYYY-MM-DD'
        bookingPOST: null      // 'https://script.google.com/macros/s/XXXX/exec'
      },
      packages: {
        Express:  { price: 200, duration: 60,  bufferAfter: 120, maxAccessories: 2,   banned:['Drone'] },
        ARTISTA:  { price: 450, duration: 180, bufferAfter: 0,   maxAccessories: 5,   banned:['Drone'] },
        Premium:  { price: 900, duration: 360, bufferAfter: 0,   maxAccessories: 999, banned:[] }
      },
      extraHourUSD: 200,
      accessories: [
        'Estabilizador (gimbal)', 'Drone', 'Kit de luces', 'Máquina de humo', 'Lente 85mm', 'Lente 28–70mm', 'Lente 11mm', 'Micrófonos / audio', 'Trípode', 'Fondos / backdrops'
      ]
    };

    // ====== STATE ======
    const state = {
      pkgKey: null,
      acc: new Set(),
      dateISO: null, // YYYY-MM-DD
      slotStart: null, // 'HH:MM'
      dayBusy: [], // [{start,end}] desde backend/demo
      lastBookingId: null // consecutivo más reciente (opcional, para Whats/UX)
    };

    // ====== UTILS ======
    const pad = n => String(n).padStart(2,'0');
    const fmtMoney = v => `$${v.toLocaleString('en-US', {minimumFractionDigits:0})}`;
    const toISODate = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const parseISODate = (iso) => { const [y,m,da]=iso.split('-').map(Number); return new Date(y, m-1, da); };
    const fmtHuman = (iso) => { const d = parseISODate(iso); return d.toLocaleDateString('es-CR', { weekday:'long', day:'2-digit', month:'long' }); };
    const addMinutes = (timeStr, mins) => { const [H,M] = timeStr.split(':').map(Number); const d = new Date(); d.setHours(H, M, 0, 0); d.setMinutes(d.getMinutes()+mins); return `${pad(d.getHours())}:${pad(d.getMinutes())}`; };
    const timeToMin = (t) => { const [H,M] = t.split(':').map(Number); return H*60+M; };
    const minToTime = (m) => `${pad(Math.floor(m/60))}:${pad(m%60)}`;
    const overlaps = (aStart, aEnd, bStart, bEnd) => { const A1=timeToMin(aStart), A2=timeToMin(aEnd), B1=timeToMin(bStart), B2=timeToMin(bEnd); return !(A2 <= B1 || A1 >= B2); };

    // ====== STORAGE (demo sin backend) ======
    const store = {
      key: 'bhouse_bookings',
      seqKey: (ymd)=> 'bhouse_seq_' + ymd, // por día de generación
      load(){ try { return JSON.parse(localStorage.getItem(this.key) || '[]'); } catch{ return []; } },
      save(arr){ localStorage.setItem(this.key, JSON.stringify(arr)); },
      nextId(){
        const ymd = new Date().toISOString().slice(0,10).replace(/-/g,''); // YYYYMMDD
        const k = this.seqKey(ymd);
        const next = (parseInt(localStorage.getItem(k)||'0',10) || 0) + 1;
        localStorage.setItem(k, String(next));
        return `BHM-${ymd}-${String(next).padStart(4,'0')}`;
      },
      add(b){ const arr = this.load(); arr.push(b); this.save(arr); },
      removeById(id){ const arr = this.load(); const norm = s => (s||'').trim().toUpperCase(); const idx = arr.findIndex(x=> norm(x.id)===norm(id)); if(idx>=0){ const [rm]=arr.splice(idx,1); this.save(arr); return rm; } return null; },
      findById(id){ const norm = s => (s||'').trim().toUpperCase(); return this.load().find(x=> norm(x.id)===norm(id)) || null; },
      busyForDate(dateISO){
        const arr = this.load().filter(b=> b.date===dateISO);
        const dayStart = minToTime(CONFIG.startHour*60);
        const dayEnd   = minToTime(CONFIG.endHour*60);
        // Si hay una Premium, todo el día queda ocupado
        if(arr.some(b=> b.pkg==='Premium')){
          return [{ start: dayStart, end: dayEnd }];
        }
        return arr.map(b=>{
          if(b.pkg==='Express'){
            const endBusy = (()=>{
              const e = addMinutes(b.end, CONFIG.packages.Express.bufferAfter);
              return timeToMin(e) > timeToMin(dayEnd) ? dayEnd : e; // clamp al cierre
            })();
            return { start: b.start, end: endBusy };
          }
          // ARTISTA u otros: solo su rango
          return { start: b.start, end: b.end };
        });
      }
    };

    // ====== ACCESSORIOS RENDER ======
    const accWrap = document.getElementById('acc-list');
    CONFIG.accessories.forEach((label)=>{
      const el = document.createElement('label');
      el.className = 'flex items-center gap-2 p-2 rounded-xl border border-white/10 hover:bg-white/5';
      el.innerHTML = `<input type="checkbox" class="h-4 w-4" data-acc="${label}"> <span>${label}</span>`;
      accWrap.appendChild(el);
    });

    function refreshAccessoryStates(){
      const pkg = state.pkgKey ? CONFIG.packages[state.pkgKey] : null;
      document.querySelectorAll('#acc-list input[type="checkbox"]').forEach(chk=>{
        const label = chk.getAttribute('data-acc');
        const banned = pkg && pkg.banned.includes(label);
        chk.disabled = !!banned;
        if(banned){ chk.checked = false; state.acc.delete(label); }
      });
    }

    accWrap.addEventListener('change', (e)=>{
      if(!e.target.matches('input[type="checkbox"]')) return;
      const label = e.target.getAttribute('data-acc');
      if(e.target.checked){ state.acc.add(label); } else { state.acc.delete(label); }
      const pkg = state.pkgKey ? CONFIG.packages[state.pkgKey] : null;
      if(pkg){
        const allowed = pkg.maxAccessories;
        if(state.acc.size > allowed){
          e.target.checked = false; state.acc.delete(label);
          alert(`En el paquete ${state.pkgKey} solo se permiten ${allowed} accesorios.`);
        }
      }
      renderSummary();
    });

    // ====== PAQUETES ======
    document.querySelectorAll('.selectPkg').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        state.pkgKey = btn.dataset.pkg;
        document.querySelectorAll('[id^="pkg-"]').forEach(c=>c.classList.remove('ring-2','ring-sky-400'));
        document.getElementById(`pkg-${state.pkgKey}`).classList.add('ring-2','ring-sky-400');
        const pkg = CONFIG.packages[state.pkgKey];
        if(state.acc.size > pkg.maxAccessories){
          state.acc = new Set([...state.acc].slice(0, pkg.maxAccessories));
        }
        document.querySelectorAll('#acc-list input[type="checkbox"]').forEach(chk=>{
          const label = chk.getAttribute('data-acc');
          chk.checked = state.acc.has(label);
        });
        refreshAccessoryStates();
        renderSummary();
        fetchAvailability();
        refreshSlots();
        window.scrollTo({top: document.body.scrollHeight/4, behavior:'smooth'});
      });
    });

    // ====== CALENDARIO ======
    const calTitle = document.getElementById('calTitle');
    const calGrid = document.getElementById('calGrid');
    const slotDateLabel = document.getElementById('slotDateLabel');
    let viewYear, viewMonth; // 0..11

    function setMonth(y,m){ viewYear=y; viewMonth=m; renderCalendar(); }

    function renderCalendar(){
      const first = new Date(viewYear, viewMonth, 1);
      const last = new Date(viewYear, viewMonth+1, 0);
      calTitle.textContent = `${first.toLocaleString('es-CR',{month:'long'})} ${viewYear}`;

      let startIdx = (first.getDay() + 6) % 7; // 0=Mon
      const cells = [];
      const prevLast = new Date(viewYear, viewMonth, 0).getDate();
      for(let i=startIdx-1;i>=0;i--){ cells.push({day: prevLast - i, other:true}); }
      for(let d=1; d<=last.getDate(); d++){ cells.push({day:d, other:false}); }
      while(cells.length % 7 !== 0){ cells.push({day: cells.length, other:true}); }

      calGrid.innerHTML = '';
      cells.forEach((c,idx)=>{
        const inMonth = !c.other;
        const date = new Date(viewYear, viewMonth, inMonth?c.day: (idx<startIdx? (new Date(viewYear, viewMonth, 0).getDate() - (startIdx-1-idx)) : (idx - (startIdx + (new Date(viewYear, viewMonth+1,0).getDate())) +1)) );
        const iso = toISODate(date);
        const isWeekend = CONFIG.workingDays.includes(date.getDay());
        const isCurrentMonth = date.getMonth()===viewMonth;
        const disabled = !isCurrentMonth || !isWeekend || date < new Date(new Date().toDateString());
        const cell = document.createElement('button');
        cell.className = `day-cell ${disabled? 'day-disabled':''}`;
        cell.dataset.iso = iso; // para ubicar por ID
        cell.innerHTML = `<div class="text-sm">${c.day}</div><div class="text-right text-[10px] text-slate-400">${isWeekend && isCurrentMonth ? 'Disponible' : ''}</div>`;
        cell.addEventListener('click', ()=>{
          if(disabled) return;
          state.dateISO = iso; slotDateLabel.textContent = `· ${fmtHuman(iso)}`;
          document.querySelectorAll('.day-cell').forEach(el=>el.classList.remove('ring-2','ring-sky-400'));
          cell.classList.add('ring-2','ring-sky-400');
          fetchAvailability().then(refreshSlots);
        });
        calGrid.appendChild(cell);
      });

      if(state.dateISO){
        const chosen = [...calGrid.querySelectorAll('.day-cell')].find(x=> x.dataset.iso===state.dateISO);
        if(chosen){ chosen.classList.add('ring-2','ring-sky-400'); }
      }
    }

    document.getElementById('prevMonth').onclick = ()=>{ const d = new Date(viewYear, viewMonth-1, 1); setMonth(d.getFullYear(), d.getMonth()); };
    document.getElementById('nextMonth').onclick = ()=>{ const d = new Date(viewYear, viewMonth+1, 1); setMonth(d.getFullYear(), d.getMonth()); };

    // ====== DISPONIBILIDAD (BACKEND + DEMO LOCAL) ======
    async function fetchAvailability(){
      state.dayBusy = [];
      if(!state.dateISO) return;

      if(CONFIG.api.availabilityGET){
        try{
          const url = `${CONFIG.api.availabilityGET}?date=${encodeURIComponent(state.dateISO)}` + (state.pkgKey? `&pkg=${encodeURIComponent(state.pkgKey)}`:'');
          const res = await fetch(url);
          const data = await res.json();
          if(data && data.ok && Array.isArray(data.busy)){
            state.dayBusy = data.busy; // backend debe incluir buffers si aplica
          }
        }catch(err){ console.warn('No availability backend:', err); }
      } else {
        // DEMO localStorage (sin backend): construir busy considerando reglas por paquete
        state.dayBusy = store.busyForDate(state.dateISO);
      }
    }

    // ====== SLOTS ======
    const slotsWrap = document.getElementById('slots');

    function makeSlotButton(labelLeft, labelRight, disabled, onPick){
      const btn = document.createElement('button');
      btn.className = 'slot w-full text-left hover:bg-white/5';
      if(disabled) btn.setAttribute('disabled','');
      btn.innerHTML = `<div><div class="font-semibold">${labelLeft}</div><div class="text-xs text-slate-400">${state.pkgKey} · ${fmtMoney(CONFIG.packages[state.pkgKey].price)}</div></div><div class="text-xs">${disabled? 'Ocupado':'Elegir'}</div>`;
      btn.addEventListener('click', ()=>{ if(disabled) return; onPick(); });
      return btn;
    }

    async function refreshSlots(){
      slotsWrap.innerHTML = '';
      if(!state.dateISO){ slotsWrap.innerHTML = `<p class=\"text-slate-400 text-sm\">Elegí primero un día del calendario.</p>`; return; }
      if(!state.pkgKey){ slotsWrap.innerHTML = `<p class=\"text-slate-400 text-sm\">Elegí primero un paquete.</p>`; return; }

      const pkg = CONFIG.packages[state.pkgKey];
      const frag = document.createDocumentFragment();

      if(state.pkgKey === 'Premium'){
        // ÚNICA opción 10:00–16:00 y si existe cualquier reserva en el día, se deshabilita
        const t = '10:00';
        const tEnd = addMinutes(t, pkg.duration); // 16:00
        const disabled = state.dayBusy.length > 0; // cualquier reserva del día bloquea Premium
        frag.appendChild(makeSlotButton(`${t} — ${tEnd} · (ocupa el día)`, '', disabled, ()=>{ state.slotStart = t; renderSummary(); }));
      }
      else if(state.pkgKey === 'ARTISTA'){
        // Solo 10, 11, 12, 13, 14, 15
        const starts = ['10:00','11:00','12:00','13:00','14:00','15:00'];
        for(const t of starts){
          const tEnd = addMinutes(t, pkg.duration); // 3h
          let disabled = false;
          for(const b of state.dayBusy){ if(overlaps(t, tEnd, b.start, b.end)){ disabled = true; break; } }
          frag.appendChild(makeSlotButton(`${t} — ${tEnd}`, '', disabled, ()=>{ state.slotStart = t; renderSummary(); }));
        }
      }
      else if(state.pkgKey === 'Express'){
        // Opciones por hora de 10:00 a 17:00 (60 min)
        for(let h=CONFIG.startHour; h<=CONFIG.endHour-1; h++){
          const t = `${pad(h)}:00`;
          const tEnd = addMinutes(t, pkg.duration);
          let disabled = false;
          for(const b of state.dayBusy){ if(overlaps(t, tEnd, b.start, b.end)){ disabled = true; break; } }
          frag.appendChild(makeSlotButton(`${t} — ${tEnd}`, '', disabled, ()=>{ state.slotStart = t; renderSummary(); }));
        }
      } else {
        // fallback (no debería usarse)
        const p = document.createElement('p'); p.className='text-slate-400 text-sm'; p.textContent='Paquete no reconocido'; frag.appendChild(p);
      }

      slotsWrap.appendChild(frag);
    }

    // ====== RESUMEN ======
    const summary = document.getElementById('summary');
    function renderSummary(){
      const pkg = state.pkgKey ? CONFIG.packages[state.pkgKey] : null;
      const accList = [...state.acc];
      const dateStr = state.dateISO ? fmtHuman(state.dateISO) : '—';
      const timeStr = state.slotStart ? `${state.slotStart} — ${state.slotStart && pkg? addMinutes(state.slotStart, pkg.duration):''}` : '—';
      const subtotal = pkg? pkg.price : 0;
      summary.innerHTML = `
        <div class=\"p-3 rounded-xl border border-white/10\">
          <div class=\"text-sm text-slate-400\">Paquete</div>
          <div class=\"font-semibold text-lg\">${state.pkgKey || 'Elegí un paquete'}</div>
          ${pkg? `<div class=\"text-sm text-slate-400\">Duración: ${pkg.duration} min · ${fmtMoney(pkg.price)}</div>`:''}
        </div>
        <div class=\"p-3 rounded-xl border border-white/10\">
          <div class=\"text-sm text-slate-400\">Fecha</div>
          <div class=\"font-semibold\">${dateStr}</div>
          <div class=\"text-sm text-slate-400\">Hora: ${timeStr}</div>
        </div>
        <div class=\"p-3 rounded-xl border border-white/10\">
          <div class=\"text-sm text-slate-400\">Accesorios (${accList.length})</div>
          <div class=\"text-sm\">${accList.length? accList.map(a=>`<span class='tag mr-1'>${a}</span>`).join(' ') : '—'}</div>
        </div>
        <div class=\"p-3 rounded-xl border border-white/10 flex items-center justify-between\">
          <div>
            <div class=\"text-sm text-slate-400\">Subtotal paquete</div>
            <div class=\"font-bold text-xl\">${fmtMoney(subtotal)}</div>
          </div>
          <div class=\"text-right text-xs text-slate-400\">Se cobrará hora extra a ${fmtMoney(CONFIG.extraHourUSD)}/h si se excede el tiempo.</div>
        </div>
      `;

      const lines = [
        'Solicitud de reserva — B House Music',
        state.lastBookingId ? `Consecutivo: ${state.lastBookingId}` : null,
        `Paquete: ${state.pkgKey || '—'}`,
        `Fecha: ${state.dateISO? fmtHuman(state.dateISO):'—'}`,
        `Hora: ${timeStr}`,
        `Accesorios: ${accList.length? accList.join(', '):'Ninguno'}`,
        `Subtotal: ${fmtMoney(subtotal)}`,
        '',
        '¿Me confirmás disponibilidad?'
      ].filter(Boolean);
      const baseMsg = encodeURIComponent(lines.join('\n'));
      const wa = `https://wa.me/${CONFIG.whatsappNumber}?text=${baseMsg}`;
      document.getElementById('btnWhats').onclick = ()=> window.open(wa,'_blank');
      document.getElementById('whatsHeader').href = wa;
    }

    // ====== FORM / BOOKING ======
    const form = document.getElementById('bookForm');
    const bookMsg = document.getElementById('bookMsg');
    form.addEventListener('submit', async (e)=>{
      e.preventDefault(); bookMsg.classList.add('hidden');
      if(!state.pkgKey || !state.dateISO || !state.slotStart){ alert('Elegí paquete, fecha y hora primero.'); return; }

      const pkg = CONFIG.packages[state.pkgKey];
      if(state.acc.size > pkg.maxAccessories){ alert(`En el paquete ${state.pkgKey} solo se permiten ${pkg.maxAccessories} accesorios.`); return; }

      const payload = {
        action: 'book',
        pkg: state.pkgKey,
        date: state.dateISO,
        start: state.slotStart,
        end: addMinutes(state.slotStart, pkg.duration),
        tz: CONFIG.TZ,
        accessories: [...state.acc],
        extraHourUSD: CONFIG.extraHourUSD,
        priceUSD: pkg.price,
        customer: Object.fromEntries(new FormData(form).entries())
      };

      if(CONFIG.api.bookingPOST){
        try{
          const res = await fetch(CONFIG.api.bookingPOST, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
          const data = await res.json();
          if(data.ok){
            state.lastBookingId = data.id || null;
            bookMsg.innerHTML = `✅ Reserva enviada. ${state.lastBookingId? `Consecutivo: <code class=\"badge\">${state.lastBookingId}</code>`: '(ID provisto por backend)'} .`;
            bookMsg.classList.remove('hidden');
            await fetchAvailability();
            refreshSlots();
            renderSummary();
          }else{
            bookMsg.textContent = 'No se pudo completar la reserva. Intenta por WhatsApp.';
            bookMsg.classList.remove('hidden');
          }
        }catch(err){ console.error(err); alert('Error de conexión. Podés confirmar por WhatsApp.'); }
        return;
      }

      // ===== DEMO LOCAL (sin backend) =====
      const busyLocal = store.busyForDate(state.dateISO);
      const wouldEnd = addMinutes(state.slotStart, pkg.duration);
      const clash = busyLocal.some(b => overlaps(state.slotStart, wouldEnd, b.start, b.end));
      if(clash){ alert('Ese horario ya está reservado localmente. Probá otro.'); return; }

      const id = store.nextId();
      const booking = { id, ...payload, createdAt: new Date().toISOString() };
      store.add(booking);
      state.lastBookingId = id;

      bookMsg.innerHTML = `✅ Reserva preparada (demo). <br><strong>Consecutivo:</strong> <code class=\"badge\">${id}</code> <button id=\"copyId\" type=\"button\" class=\"ml-2 underline\">Copiar</button>.<br>Enviá por WhatsApp para confirmar disponibilidad.`;
      bookMsg.classList.remove('hidden');
      document.getElementById('copyId').onclick = ()=> { navigator.clipboard.writeText(id).then(()=>{ document.getElementById('copyId').textContent = 'Copiado'; setTimeout(()=>document.getElementById('copyId').textContent='Copiar',1200); }); };

      await fetchAvailability();
      refreshSlots();
      renderSummary();
    });

    // ====== ICS (añadir a mi calendario) ======
    function makeICS(){
      if(!state.pkgKey || !state.dateISO || !state.slotStart) { alert('Elegí paquete, fecha y hora.'); return; }
      const pkg = CONFIG.packages[state.pkgKey];
      const start = new Date(state.dateISO + 'T' + state.slotStart + ':00');
      const end = new Date(state.dateISO + 'T' + addMinutes(state.slotStart, pkg.duration) + ':00');
      const dt = (d)=> d.toISOString().replace(/[-:]/g,'').split('.')[0] + 'Z';
      const ics = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//B House//Booking//ES\nBEGIN:VEVENT\nUID:${crypto.randomUUID()}\nDTSTAMP:${dt(new Date())}\nDTSTART:${dt(start)}\nDTEND:${dt(end)}\nSUMMARY:B House — ${state.pkgKey}\nDESCRIPTION:Accesorios: ${[...state.acc].join(', ') || 'Ninguno'}\\nContacto: WhatsApp +${CONFIG.whatsappNumber}\nLOCATION:${(new FormData(form).get('location')||'Por definir')}\nEND:VEVENT\nEND:VCALENDAR`;
      const blob = new Blob([ics], {type:'text/calendar'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download = `BHouse-${state.pkgKey}-${state.dateISO}.ics`; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1500);
    }
    document.getElementById('btnICS').onclick = makeICS;

    // ====== CANCELACIÓN POR CONSECUTIVO (demo local) ======
    const cancelInput = document.getElementById('cancelId');
    const cancelMsg = document.getElementById('cancelMsg');

    document.getElementById('btnLocate').onclick = ()=>{
      const id = (cancelInput.value||'').trim();
      if(!id){ cancelMsg.textContent = 'Ingresá el consecutivo.'; return; }
      const b = store.findById(id);
      if(!b){ cancelMsg.textContent = 'No encontré una reserva con ese consecutivo (modo demo).'; return; }
      const d = parseISODate(b.date);
      setMonth(d.getFullYear(), d.getMonth());
      state.dateISO = b.date;
      slotDateLabel.textContent = `· ${fmtHuman(b.date)}`;
      const chosen = [...calGrid.querySelectorAll('.day-cell')].find(x=> x.dataset.iso===b.date);
      document.querySelectorAll('.day-cell').forEach(el=>el.classList.remove('ring-2','ring-sky-400'));
      if(chosen){ chosen.classList.add('ring-2','ring-sky-400'); }
      fetchAvailability().then(()=>{
        refreshSlots();
        cancelMsg.textContent = `Reserva ${id}: ${b.date} ${b.start}–${b.end} (${b.pkg}).`;
        document.getElementById('slots').scrollIntoView({behavior:'smooth', block:'start'});
      });
    };

    document.getElementById('btnCancel').onclick = ()=>{
      const id = (cancelInput.value||'').trim();
      if(!id){ cancelMsg.textContent = 'Ingresá el consecutivo.'; return; }
      const removed = store.removeById(id);
      if(!removed){ cancelMsg.textContent = 'No encontré una reserva con ese consecutivo (modo demo).'; return; }
      if(state.dateISO === removed.date){ fetchAvailability().then(refreshSlots); }
      cancelMsg.textContent = `✅ Reserva ${id} eliminada y horario liberado (${removed.date} ${removed.start}–${removed.end}).`;
      if(state.lastBookingId === id) state.lastBookingId = null;
      renderSummary();
    };

    // ====== TyC modal ======
    const tcModal = document.getElementById('tcModal');
    document.getElementById('openTC').onclick = ()=> tcModal.showModal();
    document.getElementById('closeTC').onclick = ()=> tcModal.close();

    // ====== INIT ======
    (function init(){
      const now = new Date(); setMonth(now.getFullYear(), now.getMonth());
      renderSummary();
      refreshAccessoryStates();
      document.getElementById('yyyy').textContent = new Date().getFullYear();
      document.title = 'B House | Agenda de Video';
    })();

    // ====== TESTS (consola) ======
    (function runSelfTests(){
      const snapshot = { pkgKey: state.pkgKey, acc: new Set([...state.acc]), dateISO: state.dateISO, slotStart: state.slotStart, lastBookingId: state.lastBookingId };
      const results = [];
      const assert = (name, cond) => results.push(`${cond? '✅':'❌'} ${name}`);

      // Precios correctos
      assert('Precio Express $200', CONFIG.packages.Express.price === 200);
      assert('Precio ARTISTA $450', CONFIG.packages.ARTISTA.price === 450);
      assert('Precio Premium $900', CONFIG.packages.Premium.price === 900);

      // Duraciones correctas
      assert('Duración ARTISTA 180', CONFIG.packages.ARTISTA.duration === 180);
      assert('Duración Premium 360', CONFIG.packages.Premium.duration === 360);

      // Buffer: Express definido 120 min
      assert('Buffer Express 120 min', CONFIG.packages.Express.bufferAfter === 120);

      // Disponibilidad: WhatsApp link
      state.pkgKey = 'Express'; state.dateISO = toISODate(new Date()); state.slotStart = '10:00'; renderSummary();
      assert('WhatsApp link generado', !!document.getElementById('whatsHeader').href);

      // === Tests de bloqueos ===
      const storeBackup = localStorage.getItem(store.key) || '[]';
      try {
        // Limpio y creo una Premium 10:00–16:00 => ocupa el día 10:00–18:00
        localStorage.setItem(store.key, '[]');
        const today = toISODate(new Date());
        const id1 = store.nextId();
        const booking1 = { id:id1, action:'book', pkg:'Premium', date:today, start:'10:00', end:addMinutes('10:00', CONFIG.packages.Premium.duration), tz: CONFIG.TZ, accessories: [], extraHourUSD: CONFIG.extraHourUSD, priceUSD: CONFIG.packages.Premium.price, customer:{} };
        store.add(booking1);
        const busy = store.busyForDate(today);
        assert('Premium ocupa todo el día (10–18)', busy.length===1 && busy[0].start==='10:00' && busy[0].end==='18:00');

        // Express 16:00–17:00 + buffer debe bloquear hasta 18:00
        localStorage.setItem(store.key, '[]');
        const id2 = store.nextId();
        const booking2 = { id:id2, action:'book', pkg:'Express', date:today, start:'16:00', end:addMinutes('16:00', CONFIG.packages.Express.duration), tz: CONFIG.TZ, accessories: [], extraHourUSD: CONFIG.extraHourUSD, priceUSD: CONFIG.packages.Express.price, customer:{} };
        store.add(booking2);
        const busy2 = store.busyForDate(today);
        const expressBusy = busy2.find(x=> x.start==='16:00');
        assert('Express bloquea hasta las 18:00 por buffer', expressBusy && expressBusy.end==='18:00');
      } finally {
        // Restaurar almacenamiento
        localStorage.setItem(store.key, storeBackup);
      }

      // === Tests de generación de slots por paquete (sin reservas) ===
      const today = toISODate(new Date());
      state.dateISO = today; state.dayBusy = [];

      // Premium: solo 1 opción 10–16
      state.pkgKey = 'Premium'; state.slotStart=null; refreshSlots();
      const premiumBtns = [...document.querySelectorAll('#slots .slot')].filter(b=>!b.hasAttribute('disabled'));
      assert('Premium muestra 1 sola opción', premiumBtns.length === 1);
      assert('Premium opción 10:00–16:00', premiumBtns[0].textContent.includes('10:00 — 16:00'));

      // ARTISTA: 10,11,12,13,14,15
      state.pkgKey = 'ARTISTA'; state.slotStart=null; refreshSlots();
      const artistBtns = [...document.querySelectorAll('#slots .slot')].filter(b=>!b.hasAttribute('disabled'));
      const artistLabels = artistBtns.map(b=> b.textContent.match(/\d{2}:\d{2} — \d{2}:\d{2}/)[0].split(' — ')[0]);
      assert('ARTISTA 6 opciones', artistBtns.length === 6);
      assert('ARTISTA arranca en 10:00', artistLabels[0] === '10:00');
      assert('ARTISTA termina en 15:00', artistLabels[5] === '15:00');

      // Express: opciones horarias 10:00..17:00
      state.pkgKey = 'Express'; state.slotStart=null; refreshSlots();
      const expressBtns = [...document.querySelectorAll('#slots .slot')].filter(b=>!b.hasAttribute('disabled'));
      assert('Express primera 10:00', expressBtns[0].textContent.includes('10:00 — 11:00'));
      assert('Express última 17:00', expressBtns[expressBtns.length-1].textContent.includes('17:00 — 18:00'));
      assert('Express NO muestra 10:30', expressBtns.every(b=> !b.textContent.startsWith('10:30')));

      console.log('Pruebas B House →', ...results);

      // Helpers de demo
      window.__demoReset = () => { localStorage.removeItem(store.key); };
      window.__demoBook = (pkgKey='Premium', start='10:00') => {
        const pkg = CONFIG.packages[pkgKey];
        const dateISO = toISODate(new Date());
        const booking = { id: store.nextId(), action:'book', pkg: pkgKey, date: dateISO, start, end: addMinutes(start, pkg.duration), tz: CONFIG.TZ, accessories: [], extraHourUSD: CONFIG.extraHourUSD, priceUSD: pkg.price, customer:{} };
        store.add(booking);
        state.dateISO = dateISO; fetchAvailability().then(refreshSlots);
        return booking.id;
      };

      // restore snapshot
      state.pkgKey = snapshot.pkgKey; state.acc = snapshot.acc; state.dateISO = snapshot.dateISO; state.slotStart = snapshot.slotStart; state.lastBookingId = snapshot.lastBookingId; renderSummary();
    })();
  </script>
</body>
</html>
