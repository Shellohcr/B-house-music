<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>B House | Agenda de Video</title>
  <meta name="description" content="Agenda tus paquetes de video con B House. Calendario tipo hotel, paquetes y horario de fines de semana." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --brand:#0ea5e9; --ink:#0f172a; --soft:#f1f5f9; }
    html,body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#0b1220;color:#e5e7eb}
    .glass{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.08)}
    .kbd{border:1px solid #3b4252;background:#0f172a;border-radius:.5rem;padding:.15rem .4rem;font-size:.75rem}
    .cal-grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:.5rem}
    .day-cell{aspect-ratio:1/1;border-radius:.75rem;padding:.5rem;display:flex;flex-direction:column;justify-content:space-between;border:1px dashed rgba(255,255,255,.08);cursor:pointer}
    .day-disabled{opacity:.35;filter:grayscale(.3);cursor:not-allowed}
    .day-blocked{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.3);cursor:not-allowed}
    .slot{border:1px solid rgba(255,255,255,.1);border-radius:.75rem;padding:.6rem .75rem;display:flex;justify-content:space-between;align-items:center;width:100%}
    .slot[disabled]{opacity:.4;cursor:not-allowed}
    .tag{font-size:.7rem;border:1px solid rgba(255,255,255,.18);padding:.1rem .4rem;border-radius:.4rem}
  </style>
</head>
<body class="min-h-screen selection:bg-sky-500/30">
  <header class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-sky-500/20 border border-sky-500/30 flex items-center justify-center">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#38bdf8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
        </div>
        <div>
          <h1 class="text-xl sm:text-2xl font-bold tracking-tight">B House Music · Agenda de Video</h1>
          <p class="text-slate-400 text-sm">Sistema de reservas tipo hotel · sin necesidad de crear cuenta</p>
        </div>
      </div>
      <a id="whatsHeader" target="_blank" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-emerald-400/30 text-emerald-300 hover:bg-emerald-400/10 transition">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M20.52 3.48A11.86 11.86 0 0012 0C5.37 0 0 5.37 0 12a11.86 11.86 0 001.68 6.06L0 24l6.13-1.6A11.86 11.86 0 0012 24c6.63 0 12-5.37 12-12 0-3.2-1.24-6.21-3.48-8.52zM12 21.5c-1.82 0-3.54-.5-5.04-1.45l-.36-.23-3.64.95.97-3.55-.24-.37A9.5 9.5 0 1121.5 12 9.52 9.52 0 0112 21.5zm5.26-6.9c-.29-.15-1.72-.85-1.98-.95-.27-.1-.46-.15-.65.15-.19.29-.75.94-.92 1.13-.17.19-.34.21-.63.08-.29-.14-1.22-.45-2.32-1.43a8.7 8.7 0 01-1.62-2.02c-.17-.29 0-.45.13-.6.13-.15.29-.37.44-.56.15-.19.2-.32.29-.53.1-.21.05-.39-.03-.54-.08-.15-.65-1.56-.9-2.12-.24-.58-.48-.5-.65-.5-.17 0-.37-.02-.56-.02-.19 0-.52.07-.79.38-.27.29-1.04 1.02-1.04 2.48 0 1.46 1.07 2.87 1.22 3.06.15.19 2.1 3.21 5.08 4.5.71.31 1.26.5 1.69.64.71.22 1.36.19 1.87.11.57-.08 1.72-.7 1.96-1.37.24-.68.24-1.26.17-1.38-.07-.12-.26-.2-.55-.36z"/></svg>
        <span class="text-sm font-semibold">WhatsApp</span>
      </a>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-24">
    <!-- Config summary / anuncios -->
    <section class="glass rounded-2xl p-4 sm:p-6 mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="space-y-1">
          <p class="text-slate-200 text-sm">Disponibilidad: <span class="font-semibold">Sábados y Domingos</span> · <span class="font-semibold">10:00 a. m.</span> a <span class="font-semibold">6:00 p. m.</span></p>
          <p class="text-slate-400 text-xs">Express bloquea 3h, ARTISTA bloquea 5h, Premium bloquea todo el día. Extra: $200/h si se excede.
            Cámara incluida (no aparece en accesorios). En paquete Express máximo 2 accesorios. <strong>Drone no disponible en Express ni en ARTISTA.</strong></p>
        </div>
        <div class="flex gap-2 text-xs text-slate-300">
          <span class="kbd">1) Paquete</span>
          <span class="kbd">2) Día</span>
          <span class="kbd">3) Hora</span>
          <span class="kbd">4) Reservar</span>
        </div>
      </div>
    </section>

    <!-- Paquetes -->
    <section class="grid md:grid-cols-3 gap-4 mb-8">
      <div class="glass rounded-2xl p-5" id="pkg-Express">
        <div class="flex items-center justify-between mb-1">
          <h2 class="text-lg font-bold">Express</h2>
          <span class="tag">60 min</span>
        </div>
        <p class="text-2xl font-extrabold">$200</p>
        <p class="text-slate-400 text-sm mb-4">Bloquea 3 horas. Incluye cámara. Máximo 2 accesorios. <strong>Sin Drone.</strong></p>
        <button data-pkg="Express" class="selectPkg w-full mt-2 px-4 py-2 rounded-xl bg-sky-500/20 hover:bg-sky-500/30 border border-sky-400/40">Elegir Express</button>
      </div>
      <div class="glass rounded-2xl p-5" id="pkg-ARTISTA">
        <div class="flex items-center justify-between mb-1">
          <h2 class="text-lg font-bold">ARTISTA</h2>
          <span class="tag">180 min</span>
        </div>
        <p class="text-2xl font-extrabold">$450</p>
        <p class="text-slate-400 text-sm mb-4">Bloquea 5 horas. Incluye cámara. Hasta 5 accesorios. <strong>Sin Drone.</strong></p>
        <button data-pkg="ARTISTA" class="selectPkg w-full mt-2 px-4 py-2 rounded-xl bg-sky-500/20 hover:bg-sky-500/30 border border-sky-400/40">Elegir ARTISTA</button>
      </div>
      <div class="glass rounded-2xl p-5" id="pkg-Premium">
        <div class="flex items-center justify-between mb-1">
          <h2 class="text-lg font-bold">Premium</h2>
          <span class="tag">240 min</span>
        </div>
        <p class="text-2xl font-extrabold">$900</p>
        <p class="text-slate-400 text-sm mb-4">Bloquea todo el día. Paquete completo. Accesorios a elección.</p>
        <button data-pkg="Premium" class="selectPkg w-full mt-2 px-4 py-2 rounded-xl bg-sky-500/20 hover:bg-sky-500/30 border border-sky-400/40">Elegir Premium</button>
      </div>
    </section>

    <!-- Accesorios -->
    <section class="glass rounded-2xl p-5 mb-8">
      <h3 class="font-semibold mb-2">Accesorios (opcional)</h3>
      <p class="text-slate-400 text-sm mb-4">La cámara SIEMPRE va incluida. Marca solo lo que necesitas adicional. En Express se permite máximo 2 accesorios. Drone no disponible en Express ni en ARTISTA.</p>
      <div id="acc-list" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-2"></div>
    </section>

    <!-- Calendario + Slots -->
    <section class="grid lg:grid-cols-5 gap-6">
      <div class="lg:col-span-3 glass rounded-2xl p-5">
        <div class="flex items-center justify-between mb-3">
          <div>
            <h3 class="font-semibold text-lg" id="calTitle">Calendario</h3>
            <p class="text-slate-400 text-sm">Tipo hotel: elige el día disponible</p>
          </div>
          <div class="flex items-center gap-2">
            <button id="prevMonth" class="px-3 py-2 rounded-xl border border-slate-600 hover:bg-white/5">◀</button>
            <button id="nextMonth" class="px-3 py-2 rounded-xl border border-slate-600 hover:bg-white/5">▶</button>
          </div>
        </div>
        <div class="cal-grid text-sm mb-2 text-slate-400">
          <div>Lu</div><div>Ma</div><div>Mi</div><div>Ju</div><div>Vi</div><div>Sá</div><div>Do</div>
        </div>
        <div id="calGrid" class="cal-grid"></div>
        <p class="text-xs text-slate-400 mt-3">Gris = no disponible. Rojo = día bloqueado por reserva Premium. Solo fines de semana disponibles.</p>
      </div>

      <div class="lg:col-span-2 glass rounded-2xl p-5">
        <h3 class="font-semibold mb-2">Horas disponibles <span id="slotDateLabel" class="text-slate-400 font-normal"></span></h3>
        <div id="slots" class="space-y-2 min-h-[200px]"></div>
      </div>
    </section>

    <!-- Resumen/Reserva -->
    <section class="glass rounded-2xl p-5 mt-8">
      <h3 class="font-semibold mb-4">Tu reserva</h3>
      <div class="grid md:grid-cols-2 gap-6">
        <div class="space-y-3" id="summary"></div>
        <form id="bookForm" class="space-y-3">
          <div class="grid sm:grid-cols-2 gap-3">
            <div>
              <label class="text-sm text-slate-300">Nombre y apellidos</label>
              <input required name="name" class="w-full mt-1 px-3 py-2 rounded-xl bg-white/5 border border-white/10" placeholder="Tu nombre" />
            </div>
            <div>
              <label class="text-sm text-slate-300">Teléfono (WhatsApp)</label>
              <input required name="phone" class="w-full mt-1 px-3 py-2 rounded-xl bg-white/5 border border-white/10" placeholder="+506 ..." />
            </div>
          </div>
          <div class="grid sm:grid-cols-2 gap-3">
            <div>
              <label class="text-sm text-slate-300">Correo</label>
              <input type="email" required name="email" class="w-full mt-1 px-3 py-2 rounded-xl bg-white/5 border border-white/10" placeholder="tucorreo@..." />
            </div>
            <div>
              <label class="text-sm text-slate-300">Lugar / Dirección</label>
              <input name="location" class="w-full mt-1 px-3 py-2 rounded-xl bg-white/5 border border-white/10" placeholder="Ej. La Cali, San José" />
            </div>
          </div>
          <div>
            <label class="text-sm text-slate-300">Notas</label>
            <textarea name="notes" rows="3" class="w-full mt-1 px-3 py-2 rounded-xl bg-white/5 border border-white/10" placeholder="Detalles, referencias, etc."></textarea>
          </div>
          <div class="flex items-center gap-2">
            <input id="acceptTC" type="checkbox" class="h-4 w-4" required />
            <label for="acceptTC" class="text-sm">Acepto <button type="button" id="openTC" class="underline underline-offset-2">Términos y Condiciones</button></label>
          </div>
          <div class="flex flex-wrap gap-2 pt-2">
            <button id="btnReserve" class="px-4 py-2 rounded-xl bg-sky-500 text-slate-900 font-bold">Reservar</button>
            <button id="btnWhats" type="button" class="px-4 py-2 rounded-xl border border-emerald-400/40">Confirmar por WhatsApp</button>
            <button id="btnICS" type="button" class="px-4 py-2 rounded-xl border border-white/20">Añadir a mi calendario (.ics)</button>
          </div>
          <p id="bookMsg" class="text-sm text-emerald-300 mt-2 hidden"></p>
        </form>
      </div>
    </section>

    <!-- Cancelación por consecutivo -->
    <section class="glass rounded-2xl p-5 mt-6">
      <h3 class="font-semibold mb-3">Cancelar / Ver reserva (por consecutivo)</h3>
      <div class="flex flex-col sm:flex-row gap-2">
        <input id="cancelId" class="w-full px-3 py-2 rounded-xl bg-white/5 border border-white/10" placeholder="Ej. BHM-20250812-0003" />
        <button id="btnLocate" type="button" class="px-4 py-2 rounded-xl border border-white/20">Ver en calendario</button>
        <button id="btnCancel" type="button" class="px-4 py-2 rounded-xl bg-rose-500/90 text-slate-900 font-bold">Eliminar y liberar</button>
      </div>
      <p id="cancelMsg" class="text-sm mt-2 text-slate-300"></p>
    </section>

    <!-- Modal TyC -->
    <dialog id="tcModal" class="w-full max-w-3xl bg-slate-900/95 text-slate-100 rounded-2xl p-0 border border-white/10">
      <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
        <div class="flex items-center justify-between">
          <h4 class="text-lg font-bold">Términos y Condiciones — B House Music</h4>
          <button id="closeTC" class="px-3 py-2 rounded-xl border border-white/20">Cerrar</button>
        </div>
        <ol class="list-decimal list-inside text-sm text-slate-300 space-y-2">
          <li>Agenda disponible <strong>únicamente</strong> sábados y domingos entre <strong>10:00 a. m.</strong> y <strong>6:00 p. m.</strong></li>
          <li>Paquetes y precios (USD): Express $200 (bloquea 3h), ARTISTA $450 (bloquea 5h), Premium $900 (bloquea todo el día). Hora adicional: $200.</li>
          <li>Paquete Express permite <strong>máximo 2</strong> accesorios. <strong>Drone no disponible en Express ni en ARTISTA.</strong> La cámara está incluida en todos los paquetes.</li>
          <li>El tiempo de bloqueo es para garantizar exclusividad y preparación del equipo.</li>
          <li>Reprogramaciones: con mínimo 48 h de anticipación. El mismo día no se reprograma salvo fuerza mayor.</li>
          <li>Al reservar se solicita confirmación por WhatsApp. La fecha no se garantiza sin confirmación.</li>
          <li>El desplazamiento fuera del GAM puede generar costos adicionales.</li>
          <li>Al enviar la reserva aceptas estas condiciones.</li>
        </ol>
      </div>
    </dialog>
  </main>

  <footer class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-10 pt-6 text-center text-xs text-slate-400">
    © <span id="yyyy"></span> B House Music · Hecho con ♥ · <a class="underline" target="_blank" href="https://wa.me/50670166631">WhatsApp</a>
  </footer>

  <script>
    // ====== CONFIG EDITABLE ======
    const CONFIG = {
      TZ: 'America/Costa_Rica',
      workingDays: [0,6], // 0=Dom, 6=Sab (solo fines de semana)
      startHour: 10,      // 10:00
      endHour: 18,        // 18:00 -> la sesión debe terminar a esta hora o antes
      stepMinutes: 30,    // intervalos para mostrar slots
      whatsappNumber: '50670166631',
      api: { availabilityGET: null, bookingPOST: null },
      packages: {
        Express:  { price: 200, duration: 60,  blockHours: 3,   maxAccessories: 2,   banned:['Drone'] },
        ARTISTA:  { price: 450, duration: 180, blockHours: 5,   maxAccessories: 5,   banned:['Drone'] },
        Premium:  { price: 900, duration: 240, blockHours: 8,   maxAccessories: 999, banned:[] } // 8h = todo el día (10am-6pm)
      },
      extraHourUSD: 200,
      accessories: [
        'Estabilizador (gimbal)', 'Drone', 'Kit de luces', 'Máquina de humo', 'Lente 85mm', 'Lente 28–70mm', 'Lente 11mm', 'Micrófonos / audio', 'Trípode', 'Fondos / backdrops'
      ]
    };

    // ====== STATE ======
    const state = {
      pkgKey: null,
      acc: new Set(),
      dateISO: null,
      slotStart: null,
      blockedDays: new Set(), // días completamente bloqueados por Premium
      lastBookingId: null,
      viewDate: new Date() // mes en vista
    };

    // ====== STORAGE (local) ======
    const store = {
      key: 'bhouse_bookings',
      seqKey: (dateStr)=> 'bhouse_seq_' + dateStr,
      load(){ try { return JSON.parse(localStorage.getItem(this.key) || '[]'); } catch{ return []; } },
      save(arr){ localStorage.setItem(this.key, JSON.stringify(arr)); },
      nextId(){
        const today = new Date();
        const ymd = today.toISOString().slice(0,10).replace(/-/g,'');
        const k = this.seqKey(ymd);
        const next = (parseInt(localStorage.getItem(k)||'0',10) || 0) + 1;
        localStorage.setItem(k, String(next));
        return `BHM-${ymd}-${String(next).padStart(4,'0')}`;
      },
      addBooking(b){ const arr = this.load(); arr.push(b); this.save(arr); },
      removeById(id){
        const arr = this.load();
        const idx = arr.findIndex(x=> x.id===id);
        if(idx>=0){ const [removed]=arr.splice(idx,1); this.save(arr); return removed; }
        return null;
      },
      findById(id){ return this.load().find(x=>x.id===id) || null; },
      busyForDate(dateISO){
        return this.load()
          .filter(b=> b.date===dateISO)
          .map(b=> ({start:b.start, end:b.end, pkg:b.pkg})); // end ya incluye bloqueo
      },
      getBlockedDays(){
        const bookings = this.load();
        const blocked = new Set();
        bookings.forEach(b => { if(b.pkg === 'Premium') blocked.add(b.date); });
        return blocked;
      }
    };

    // ====== UTILS TIEMPO ======
    const pad = n => String(n).padStart(2,'0');
    const fmtMoney = v => `$${v.toLocaleString('en-US', {minimumFractionDigits:0})}`;
    const toISODate = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const parseISODate = (iso) => { const [y,m,da]=iso.split('-').map(Number); return new Date(y, m-1, da); };
    const fmtHuman = (iso) => { const d = parseISODate(iso); return d.toLocaleDateString('es-CR', { weekday:'long', day:'2-digit', month:'long' }); };
    const hmToMin = (t) => { const [H,M] = t.split(':').map(Number); return H*60+M; };
    const minToHm = (m) => { const H = Math.floor(m/60), M = m%60; return `${pad(H)}:${pad(M)}`; };
    const clampDayStart = (H) => Math.max(H, CONFIG.startHour);
    const overlaps = (aStart, aEnd, bStart, bEnd) => !(aEnd <= bStart || aStart >= bEnd);

    // ====== ACCESORIOS RENDER ======
    const accWrap = document.getElementById('acc-list');
    CONFIG.accessories.forEach((label)=>{
      const el = document.createElement('label');
      el.className = 'flex items-center gap-2 p-2 rounded-xl border border-white/10 hover:bg-white/5';
      el.innerHTML = `<input type="checkbox" class="h-4 w-4" data-acc="${label}"> <span>${label}</span>`;
      accWrap.appendChild(el);
    });

    function refreshAccessoryStates(){
      const pkg = state.pkgKey ? CONFIG.packages[state.pkgKey] : null;
      document.querySelectorAll('#acc-list input[type="checkbox"]').forEach(chk=>{
        const label = chk.getAttribute('data-acc');
        const banned = pkg && pkg.banned.includes(label);
        chk.disabled = !!banned;
        if(banned){ chk.checked = false; state.acc.delete(label); }
      });
    }

    accWrap.addEventListener('change', (e)=>{
      if(!e.target.matches('input[type="checkbox"])')) return;
      const label = e.target.getAttribute('data-acc');
      if(e.target.checked){ state.acc.add(label); } else { state.acc.delete(label); }
      const pkg = state.pkgKey ? CONFIG.packages[state.pkgKey] : null;
      if(pkg){
        const allowed = pkg.maxAccessories;
        if(state.acc.size > allowed){
          e.target.checked = false; state.acc.delete(label);
          alert(`En el paquete ${state.pkgKey} solo se permiten ${allowed} accesorios.`);
        }
      }
      renderSummary();
    });

    // ====== CALENDARIO ======
    const calGrid = document.getElementById('calGrid');
    const calTitle = document.getElementById('calTitle');
    document.getElementById('prevMonth').addEventListener('click', ()=>{ state.viewDate.setMonth(state.viewDate.getMonth()-1); renderCalendar(); });
    document.getElementById('nextMonth').addEventListener('click', ()=>{ state.viewDate.setMonth(state.viewDate.getMonth()+1); renderCalendar(); });

    function updateBlockedDays(){ state.blockedDays = store.getBlockedDays(); }

    function renderCalendar(){
      const y = state.viewDate.getFullYear();
      const m = state.viewDate.getMonth();
      const first = new Date(y, m, 1);
      const firstD = (first.getDay() + 6) % 7; // lunes=0..dom=6
      const daysInMonth = new Date(y, m+1, 0).getDate();
      calTitle.textContent = `Calendario — ${first.toLocaleDateString('es-CR',{month:'long', year:'numeric'})}`;
      calGrid.innerHTML = '';

      // Celditas en blanco al inicio
      for(let i=0;i<firstD;i++){ const p=document.createElement('div'); p.className='opacity-0'; calGrid.appendChild(p); }

      for(let d=1; d<=daysInMonth; d++){
        const date = new Date(y, m, d);
        const iso = toISODate(date);
        const day = date.getDay(); // 0 dom .. 6 sab
        const isWeekend = (day===0 || day===6);
        const isBlocked = state.blockedDays.has(iso);

        const cell = document.createElement('button');
        cell.className = 'day-cell text-left';
        if(!isWeekend) cell.classList.add('day-disabled');
        if(isBlocked) cell.classList.add('day-blocked');

        cell.innerHTML = `<div class="text-sm font-bold">${d}</div>
          <div class="text-[10px] text-slate-400">${isBlocked ? 'Bloqueado' : (isWeekend? 'Disponible' : '—')}</div>`;

        if(isWeekend && !isBlocked){
          cell.addEventListener('click', ()=>{
            state.dateISO = iso;
            document.querySelectorAll('.day-cell').forEach(c=>c.classList.remove('ring-2','ring-sky-400'));
            cell.classList.add('ring-2','ring-sky-400');
            renderSlots();
            renderSummary();
          });
        } else {
          cell.disabled = true;
        }
        calGrid.appendChild(cell);
      }
    }

    // ====== SLOTS ======
    const slotWrap = document.getElementById('slots');
    const slotDateLabel = document.getElementById('slotDateLabel');

    function listSlotsFor(dateISO){
      const pkg = state.pkgKey ? CONFIG.packages[state.pkgKey] : null;
      slotWrap.innerHTML = '';
      slotDateLabel.textContent = dateISO ? `· ${fmtHuman(dateISO)}` : '';

      if(!dateISO){ slotWrap.innerHTML = '<p class="text-slate-400 text-sm">Elige un día.</p>'; return; }
      if(!pkg){ slotWrap.innerHTML = '<p class="text-slate-400 text-sm">Primero elige un paquete.</p>'; return; }

      // Slots Premium: día completo, una sola opción
      if(state.pkgKey==='Premium'){
        const dayBusy = store.busyForDate(dateISO);
        const blocked = state.blockedDays.has(dateISO);
        const btn = document.createElement('button');
        btn.className='slot';
        btn.textContent = blocked? 'Día completo no disponible' : 'Reservar día completo (10:00–18:00)';
        btn.disabled = blocked;
        if(!blocked){ btn.addEventListener('click', ()=>{ state.slotStart = '10:00'; renderSummary(); }); }
        slotWrap.appendChild(btn);
        return;
      }

      // Para Express/ARTISTA calcular ventanas disponibles
      const busy = store.busyForDate(dateISO).map(b=>({
        s: hmToMin(b.start),
        e: hmToMin(b.end)
      }));

      const durBlock = CONFIG.packages[state.pkgKey].blockHours * 60; // minutos
      const durSession = CONFIG.packages[state.pkgKey].duration; // minutos
      const startMin = CONFIG.startHour*60;
      const endMin = CONFIG.endHour*60;

      for(let t=startMin; t<=endMin; t+=CONFIG.stepMinutes){
        const candidateStart = t;
        const sessionEnd = candidateStart + durSession;
        const blockEnd = candidateStart + durBlock; // bloqueamos hacia adelante

        // La sesión (no el bloqueo) debe terminar <= endHour
        if(sessionEnd > endMin) break;

        // El bloqueo no debe pasar el fin de día (para mantener la regla de exclusividad en el mismo día)
        if(blockEnd > endMin) continue;

        const conflicts = busy.some(b => overlaps(candidateStart, blockEnd, b.s, b.e));
        const label = `${minToHm(candidateStart)} – ${minToHm(sessionEnd)}`;
        const btn = document.createElement('button');
        btn.className='slot';
        btn.innerHTML = `<span>${label}</span> <span class="text-slate-400 text-xs">bloquea hasta ${minToHm(blockEnd)}</span>`;
        btn.disabled = conflicts;
        if(!conflicts){ btn.addEventListener('click', ()=>{ state.slotStart = minToHm(candidateStart); renderSummary(); }); }
        slotWrap.appendChild(btn);
      }

      if(!slotWrap.children.length){ slotWrap.innerHTML = '<p class="text-slate-400 text-sm">No hay horarios disponibles con ese paquete. Prueba otro día o paquete.</p>'; }
    }

    function renderSlots(){ listSlotsFor(state.dateISO); }

    // ====== RESUMEN ======
    const summary = document.getElementById('summary');
    function renderSummary(){
      const pkg = state.pkgKey ? CONFIG.packages[state.pkgKey] : null;
      const acc = [...state.acc];
      const parts = [];
      parts.push(`<div class="text-sm">Paquete: <span class="font-semibold">${state.pkgKey || '—'}</span></div>`);
      parts.push(`<div class="text-sm">Fecha: <span class="font-semibold">${state.dateISO ? fmtHuman(state.dateISO) : '—'}</span></div>`);
      parts.push(`<div class="text-sm">Hora: <span class="font-semibold">${state.slotStart || '—'}</span></div>`);
      parts.push(`<div class="text-sm">Precio: <span class="font-semibold">${pkg ? fmtMoney(pkg.price) : '—'}</span> <span class="text-slate-400">(hora adicional ${fmtMoney(CONFIG.extraHourUSD)})</span></div>`);
      parts.push(`<div class="text-sm">Accesorios: <span class="font-semibold">${acc.length? acc.join(', ') : 'ninguno'}</span></div>`);
      summary.innerHTML = parts.join('');
    }

    // ====== BOOKING ======
    function selectedReady(){
      if(!state.pkgKey){ alert('Elegí un paquete.'); return false; }
      if(!state.dateISO){ alert('Elegí un día en el calendario.'); return false; }
      if(state.pkgKey!=='Premium' && !state.slotStart){ alert('Elegí una hora.'); return false; }
      return true;
    }

    function buildBookingObj(form){
      const pkg = CONFIG.packages[state.pkgKey];
      let start = state.slotStart || '10:00';
      let end;
      if(state.pkgKey==='Premium'){
        start = '10:00';
        end = '18:00';
      } else {
        const blockMins = pkg.blockHours*60;
        end = minToHm(hmToMin(start)+blockMins);
      }
      return {
        id: store.nextId(),
        date: state.dateISO,
        start, end,
        pkg: state.pkgKey,
        acc: [...state.acc],
        customer: {
          name: form.name.value.trim(),
          phone: form.phone.value.trim(),
          email: form.email.value.trim(),
          location: form.location.value.trim(),
          notes: form.notes.value.trim()
        },
        createdAt: new Date().toISOString()
      };
    }

    // Enviar a WhatsApp (pre-fill)
    function openWhatsAppWith(b){
      const txt = [
        `Hola B House 👋`,
        `Quiero confirmar esta reserva:`,
        `ID: ${b.id}`,
        `Paquete: ${b.pkg}`,
        `Fecha: ${fmtHuman(b.date)}`,
        `Hora: ${b.start}${b.pkg==='Premium'?' (día completo)':''}`,
        `Accesorios: ${b.acc.length? b.acc.join(', '):'ninguno'}`,
        `Nombre: ${b.customer.name}`,
        `Tel: ${b.customer.phone}`,
        `Correo: ${b.customer.email}`,
        b.customer.location? `Lugar: ${b.customer.location}`: '',
        b.customer.notes? `Notas: ${b.customer.notes}`: ''
      ].filter(Boolean).join('%0A');
      const url = `https://wa.me/${CONFIG.whatsappNumber}?text=${txt}`;
      window.open(url,'_blank');
    }

    // ====== FORM HANDLERS ======
    const form = document.getElementById('bookForm');
    const btnReserve = document.getElementById('btnReserve');
    const btnWhats = document.getElementById('btnWhats');
    const btnICS = document.getElementById('btnICS');
    const bookMsg = document.getElementById('bookMsg');

    form.addEventListener('submit', (e)=> e.preventDefault());

    btnReserve.addEventListener('click', (e)=>{
      e.preventDefault();
      if(!selectedReady()) return;
      if(!document.getElementById('acceptTC').checked){ alert('Debes aceptar los Términos y Condiciones.'); return; }
      const b = buildBookingObj(form);

      // Guardar
      store.addBooking(b);
      state.lastBookingId = b.id;
      updateBlockedDays();
      renderCalendar();
      renderSlots();
      renderSummary();

      // UX
      bookMsg.classList.remove('hidden');
      bookMsg.textContent = `✔ Reserva creada. Consecutivo: ${b.id}. Usa ese ID para cancelar.`;
      // scroll a cancelación para que lo vean
      document.getElementById('cancelId').value = b.id;
      document.getElementById('cancelMsg').textContent = '';
      window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' });
    });

    btnWhats.addEventListener('click', ()=>{
      if(!selectedReady()) return;
      const fake = buildBookingObj(form); // solo para armar el mensaje
      openWhatsAppWith(fake);
    });

    btnICS.addEventListener('click', ()=>{
      if(!selectedReady()) return;
      const pkg = CONFIG.packages[state.pkgKey];
      const startHM = state.slotStart || '10:00';
      const startLocal = `${state.dateISO}T${startHM}:00`;
      const endHM = (state.pkgKey==='Premium')? '18:00' : minToHm(hmToMin(startHM)+pkg.duration);
      const endLocal = `${state.dateISO}T${endHM}:00`;
      const uid = crypto.randomUUID();
      const ics = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//B House Music//Agenda//ES\nBEGIN:VEVENT\nUID:${uid}\nDTSTAMP:${new Date().toISOString().replace(/[-:]/g,'').replace(/\..+/,'Z')}\nDTSTART:${state.dateISO.replace(/-/g,'')}T${startHM.replace(':','')}00\nDTEND:${state.dateISO.replace(/-/g,'')}T${endHM.replace(':','')}00\nSUMMARY:${state.pkgKey} — B House Music\nDESCRIPTION:Reserva ${state.pkgKey} en B House Music. Accesorios: ${[...state.acc].join(', ')}\nLOCATION:${form.location.value}\nEND:VEVENT\nEND:VCALENDAR`;
      const blob = new Blob([ics], {type:'text/calendar'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `BHM-${state.pkgKey}-${state.dateISO}.ics`;
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // ====== CANCELACIÓN ======
    const cancelIdInput = document.getElementById('cancelId');
    const btnLocate = document.getElementById('btnLocate');
    const btnCancel = document.getElementById('btnCancel');
    const cancelMsg = document.getElementById('cancelMsg');

    btnLocate.addEventListener('click', ()=>{
      const id = cancelIdInput.value.trim();
      if(!id) { cancelMsg.textContent = 'Ingresá un consecutivo.'; return; }
      const b = store.findById(id);
      if(!b){ cancelMsg.textContent = 'No se encontró una reserva con ese consecutivo.'; return; }
      state.viewDate = parseISODate(b.date);
      state.dateISO = b.date;
      renderCalendar();
      // marcar el día seleccionado
      [...document.querySelectorAll('.day-cell')].forEach(el=>{
        if(el.textContent.trim().startsWith(String(parseISODate(b.date).getDate()))) el.classList.add('ring-2','ring-sky-400');
      });
      renderSlots();
      cancelMsg.textContent = `Reserva ${b.id}: ${b.pkg} el ${fmtHuman(b.date)} a las ${b.start}.`;
    });

    btnCancel.addEventListener('click', ()=>{
      const id = cancelIdInput.value.trim();
      if(!id) { cancelMsg.textContent = 'Ingresá un consecutivo.'; return; }
      const removed = store.removeById(id);
      if(removed){
        updateBlockedDays();
        renderCalendar();
        renderSlots();
        cancelMsg.textContent = `✔ Reserva ${id} eliminada y horarios liberados.`;
      } else {
        cancelMsg.textContent = 'No se encontró una reserva con ese consecutivo.';
      }
    });

    // ====== MODAL TyC ======
    const tcModal = document.getElementById('tcModal');
    document.getElementById('openTC').addEventListener('click', ()=> tcModal.showModal());
    document.getElementById('closeTC').addEventListener('click', ()=> tcModal.close());

    // ====== VARIOS ======
    document.getElementById('yyyy').textContent = new Date().getFullYear();
    document.getElementById('whatsHeader').href = `https://wa.me/${CONFIG.whatsappNumber}`;

    // ====== INIT ======
    function fetchAvailability(){ /* sin backend: solo localStorage */ }
    function boot(){ updateBlockedDays(); renderCalendar(); renderSlots(); renderSummary(); fetchAvailability(); }

    // ====== PAQUETES (listeners al final para asegurar DOM) ======
    document.querySelectorAll('.selectPkg').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        state.pkgKey = btn.dataset.pkg;
        // UI paquete activo
        document.querySelectorAll('[id^="pkg-"]').forEach(c=>c.classList.remove('ring-2','ring-sky-400'));
        document.getElementById(`pkg-${state.pkgKey}`).classList.add('ring-2','ring-sky-400');
        // Ajustes accesorios y resumen
        const pkg = CONFIG.packages[state.pkgKey];
        if(state.acc.size > pkg.maxAccessories){ state.acc = new Set([...state.acc].slice(0, pkg.maxAccessories)); }
        document.querySelectorAll('#acc-list input[type="checkbox"]').forEach(chk=>{ const label = chk.getAttribute('data-acc'); chk.checked = state.acc.has(label); });
        refreshAccessoryStates();
        // Reiniciar hora seleccionada al cambiar paquete
        state.slotStart = null;
        renderSummary();
        updateBlockedDays();
        renderCalendar();
        renderSlots();
        window.scrollTo({top: 0, behavior:'smooth'});
      });
    });

    boot();
  </script>
</body>
</html>
